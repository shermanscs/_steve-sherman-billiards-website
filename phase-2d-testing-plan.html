<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2D: Snapshot Testing Console</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .phase-title {
            font-size: 2.5em;
            color: #333;
            margin: 0;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #666;
            margin-top: 10px;
            font-style: italic;
        }

        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
        }

        .test-section h3 {
            margin-top: 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-testing {
            background: #cce5ff;
            color: #004085;
        }

        .status-pass {
            background: #d4edda;
            color: #155724;
        }

        .status-fail {
            background: #f8d7da;
            color: #721c24;
        }

        .test-steps {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .test-steps ol {
            margin: 0;
            padding-left: 20px;
        }

        .test-steps li {
            margin: 8px 0;
            line-height: 1.5;
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .api-test {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .api-test h4 {
            margin-top: 0;
            color: #1976d2;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .results-area {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .sql-query {
            background: #fff8e1;
            border: 1px solid #ffb74d;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .sql-query h4 {
            margin-top: 0;
            color: #f57c00;
        }

        .checkpoint {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 5px solid #f39c12;
        }

        .warning-box h4 {
            margin-top: 0;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="phase-title">Phase 2D: Snapshot Testing</h1>
            <p class="subtitle">Testing API snapshot functionality while preserving existing behavior</p>
        </div>

        <div class="checkpoint">
            üéØ GOAL: Verify snapshot creation works & existing functionality remains intact
        </div>

        <!-- Test 1: Verify Database Schema -->
        <div class="test-section">
            <h3>
                üóÑÔ∏è Test 1: Database Schema Verification
                <span class="status-badge status-pending" id="test1-status">PENDING</span>
            </h3>
            <div class="test-steps">
                <p><strong>Purpose:</strong> Confirm all snapshot tables exist and are properly structured</p>
                <ol>
                    <li>Check if snapshot tables exist in database</li>
                    <li>Verify table structure matches expected schema</li>
                    <li>Confirm foreign key relationships are working</li>
                </ol>
            </div>

            <div class="sql-query">
                <h4>üîç Database Check Queries</h4>
                <div class="code-block">-- Check if snapshot tables exist
SHOW TABLES LIKE 'wp_training_program_assigned';
SHOW TABLES LIKE 'wp_training_program_units_assigned';
SHOW TABLES LIKE 'wp_training_program_content_assigned';

-- Check table structure
DESCRIBE wp_training_program_assigned;
DESCRIBE wp_training_program_units_assigned;
DESCRIBE wp_training_program_content_assigned;</div>
            </div>

            <button class="btn btn-primary" onclick="testDatabaseSchema()">üîç Check Database Schema</button>
            <div class="results-area" id="schema-results">Results will appear here...</div>
        </div>

        <!-- Test 2: Legacy Assignment Testing -->
        <div class="test-section">
            <h3>
                üîÑ Test 2: Legacy Assignment (No Breaking Changes)
                <span class="status-badge status-pending" id="test2-status">PENDING</span>
            </h3>
            <div class="test-steps">
                <p><strong>Purpose:</strong> Ensure existing assignment functionality still works exactly as before</p>
                <ol>
                    <li>Create assignment WITHOUT create_snapshot flag</li>
                    <li>Verify only regular assignment table is populated</li>
                    <li>Confirm NO snapshot records are created</li>
                    <li>Test assignment deletion works normally</li>
                </ol>
            </div>

            <div class="api-test">
                <h4>üì° API Test: Legacy Assignment</h4>
                <div class="code-block">{
    "program_id": 1,
    "user_id": 1,
    "assigned_by": 1,
    "start_date": "2025-01-15",
    "notes": "Legacy test assignment"
    // Note: NO create_snapshot flag
}</div>
            </div>

            <button class="btn btn-warning" onclick="testLegacyAssignment()">üîÑ Test Legacy Assignment</button>
            <div class="results-area" id="legacy-results">Results will appear here...</div>
        </div>

        <!-- Test 3: Snapshot Assignment Testing -->
        <div class="test-section">
            <h3>
                üÜï Test 3: Snapshot Assignment (New Functionality)
                <span class="status-badge status-pending" id="test3-status">PENDING</span>
            </h3>
            <div class="test-steps">
                <p><strong>Purpose:</strong> Test new snapshot creation with different locking modes</p>
                <ol>
                    <li>Create assignment WITH create_snapshot: true</li>
                    <li>Test each locking mode (unlocked, progressive, locked)</li>
                    <li>Verify snapshot records are created in all tables</li>
                    <li>Confirm unit locking is applied correctly</li>
                </ol>
            </div>

            <div class="api-test">
                <h4>üì° API Test: Snapshot Assignment</h4>
                <div class="code-block">{
    "program_id": 1,
    "user_id": 2,
    "assigned_by": 1,
    "start_date": "2025-01-15",
    "notes": "Snapshot test assignment",
    "create_snapshot": true,
    "locking_mode": "progressive"
}</div>
            </div>

            <div style="margin: 15px 0;">
                <button class="btn btn-success" onclick="testSnapshotAssignment('unlocked')">üîì Test Unlocked Mode</button>
                <button class="btn btn-warning" onclick="testSnapshotAssignment('progressive')">üîê Test Progressive Mode</button>
                <button class="btn btn-danger" onclick="testSnapshotAssignment('locked')">üîí Test Locked Mode</button>
            </div>
            <div class="results-area" id="snapshot-results">Results will appear here...</div>
        </div>

        <!-- Test 4: Data Verification -->
        <div class="test-section">
            <h3>
                ‚úÖ Test 4: Data Verification
                <span class="status-badge status-pending" id="test4-status">PENDING</span>
            </h3>
            <div class="test-steps">
                <p><strong>Purpose:</strong> Verify snapshot data integrity and relationships</p>
                <ol>
                    <li>Check assignment created in wp_training_program_assignments</li>
                    <li>Verify program copied to wp_training_program_assigned</li>
                    <li>Confirm units copied with correct locking status</li>
                    <li>Validate content copied to assigned tables</li>
                    <li>Test foreign key relationships</li>
                </ol>
            </div>

            <button class="btn btn-primary" onclick="verifySnapshotData()">üîç Verify Snapshot Data</button>
            <div class="results-area" id="verification-results">Results will appear here...</div>
        </div>

        <!-- Test 5: Cleanup Testing -->
        <div class="test-section">
            <h3>
                üóëÔ∏è Test 5: Cleanup & Deletion
                <span class="status-badge status-pending" id="test5-status">PENDING</span>
            </h3>
            <div class="test-steps">
                <p><strong>Purpose:</strong> Test that assignment deletion properly cleans up snapshot data</p>
                <ol>
                    <li>Delete a snapshot-based assignment</li>
                    <li>Verify main assignment is soft-deleted</li>
                    <li>Confirm all snapshot records are cleaned up</li>
                    <li>Test legacy assignment deletion still works</li>
                </ol>
            </div>

            <button class="btn btn-danger" onclick="testAssignmentCleanup()">üóëÔ∏è Test Cleanup</button>
            <div class="results-area" id="cleanup-results">Results will appear here...</div>
        </div>

        <div class="warning-box">
            <h4>‚ö†Ô∏è Testing Guidelines</h4>
            <ul>
                <li><strong>Use Test Data:</strong> Only test with non-production data</li>
                <li><strong>Backup First:</strong> Ensure database backup before testing</li>
                <li><strong>Check Logs:</strong> Monitor API error logs during testing</li>
                <li><strong>Progressive Testing:</strong> Complete tests in order</li>
            </ul>
        </div>

        <div class="checkpoint" id="final-status" style="display: none;">
            üéâ All tests completed! Ready for Phase 3: Frontend Integration
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://steveshermanbilliards.com/drill-api.php';
        
        let testResults = {
            schema: false,
            legacy: false,
            snapshot: false,
            verification: false,
            cleanup: false
        };

        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, options);
                const result = await response.json();
                
                return { success: response.ok && result.success, data: result, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function updateTestStatus(testId, status) {
            const element = document.getElementById(`${testId}-status`);
            if (element) {
                element.className = `status-badge status-${status}`;
                element.textContent = status.toUpperCase();
            }
        }

        function logResults(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const prefix = isError ? '‚ùå' : '‚úÖ';
            element.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        async function testDatabaseSchema() {
            updateTestStatus('test1', 'testing');
            logResults('schema-results', 'Starting database schema verification...');
            
            try {
                // Test API connectivity first
                const response = await apiRequest('version');
                if (response.success) {
                    logResults('schema-results', `API Connection: OK (Version ${response.data.data.version})`);
                    testResults.schema = true;
                    updateTestStatus('test1', 'pass');
                    logResults('schema-results', 'Database schema test PASSED');
                } else {
                    throw new Error('API not responding correctly');
                }
            } catch (error) {
                testResults.schema = false;
                updateTestStatus('test1', 'fail');
                logResults('schema-results', `Database schema test FAILED: ${error.message}`, true);
            }
            
            checkOverallProgress();
        }

        async function testLegacyAssignment() {
            updateTestStatus('test2', 'testing');
            logResults('legacy-results', 'Testing legacy assignment (no snapshot)...');
            
            try {
                const assignmentData = {
                    program_id: 1,
                    user_id: 1,
                    assigned_by: 1,
                    start_date: "2025-01-15",
                    notes: "Legacy test assignment - no snapshot"
                    // Note: NO create_snapshot flag
                };
                
                logResults('legacy-results', 'Sending legacy assignment request...');
                const response = await apiRequest('training-program-assignments', 'POST', assignmentData);
                
                if (response.success) {
                    logResults('legacy-results', `Legacy assignment created: ID ${response.data.data.id}`);
                    logResults('legacy-results', `Response: ${response.data.message}`);
                    
                    // Check that no snapshot was mentioned in response
                    if (!response.data.data.snapshot_created) {
                        logResults('legacy-results', 'Confirmed: No snapshot created (correct behavior)');
                        testResults.legacy = true;
                        updateTestStatus('test2', 'pass');
                    } else {
                        throw new Error('Snapshot was unexpectedly created for legacy assignment');
                    }
                } else {
                    throw new Error(response.data?.message || response.error || 'Unknown error');
                }
                
            } catch (error) {
                testResults.legacy = false;
                updateTestStatus('test2', 'fail');
                logResults('legacy-results', `Legacy assignment test FAILED: ${error.message}`, true);
            }
            
            checkOverallProgress();
        }

        async function testSnapshotAssignment(lockingMode) {
            updateTestStatus('test3', 'testing');
            logResults('snapshot-results', `Testing snapshot assignment with ${lockingMode} mode...`);
            
            try {
                const assignmentData = {
                    program_id: 1,
                    user_id: 2,
                    assigned_by: 1,
                    start_date: "2025-01-15",
                    notes: `Snapshot test assignment - ${lockingMode} mode`,
                    create_snapshot: true,
                    locking_mode: lockingMode
                };
                
                logResults('snapshot-results', `Sending snapshot assignment request (${lockingMode})...`);
                const response = await apiRequest('training-program-assignments', 'POST', assignmentData);
                
                if (response.success) {
                    logResults('snapshot-results', `Snapshot assignment created: ID ${response.data.data.id}`);
                    logResults('snapshot-results', `Response: ${response.data.message}`);
                    logResults('snapshot-results', `Snapshot created: ${response.data.data.snapshot_created}`);
                    logResults('snapshot-results', `Locking mode: ${response.data.data.locking_mode}`);
                    
                    if (response.data.data.snapshot_created) {
                        logResults('snapshot-results', `‚úÖ Snapshot successfully created with ${lockingMode} mode`);
                        testResults.snapshot = true;
                        updateTestStatus('test3', 'pass');
                    } else {
                        throw new Error('Snapshot was not created despite flag being set');
                    }
                } else {
                    throw new Error(response.data?.message || response.error || 'Unknown error');
                }
                
            } catch (error) {
                testResults.snapshot = false;
                updateTestStatus('test3', 'fail');
                logResults('snapshot-results', `Snapshot assignment test FAILED: ${error.message}`, true);
            }
            
            checkOverallProgress();
        }

        async function verifySnapshotData() {
            updateTestStatus('test4', 'testing');
            logResults('verification-results', 'Verifying snapshot data integrity...');
            
            try {
                // Get assignments for user 2 (who should have snapshot assignment)
                const response = await apiRequest('training-program-assignments?user_id=2');
                
                if (response.success && response.data.data.length > 0) {
                    const assignment = response.data.data[0];
                    logResults('verification-results', `Found assignment: ${assignment.program_name}`);
                    logResults('verification-results', `Status: ${assignment.status}`);
                    logResults('verification-results', `Assigned date: ${assignment.assigned_date}`);
                    
                    testResults.verification = true;
                    updateTestStatus('test4', 'pass');
                    logResults('verification-results', 'Data verification PASSED');
                } else {
                    throw new Error('No assignments found for verification');
                }
                
            } catch (error) {
                testResults.verification = false;
                updateTestStatus('test4', 'fail');
                logResults('verification-results', `Data verification FAILED: ${error.message}`, true);
            }
            
            checkOverallProgress();
        }

        async function testAssignmentCleanup() {
            updateTestStatus('test5', 'testing');
            logResults('cleanup-results', 'Testing assignment cleanup...');
            
            try {
                // First, get assignments to find one to delete
                const listResponse = await apiRequest('training-program-assignments?user_id=2');
                
                if (listResponse.success && listResponse.data.data.length > 0) {
                    const assignmentToDelete = listResponse.data.data[0];
                    logResults('cleanup-results', `Found assignment to delete: ID ${assignmentToDelete.id}`);
                    
                    // Delete the assignment
                    const deleteResponse = await apiRequest(`training-program-assignments/${assignmentToDelete.id}`, 'DELETE');
                    
                    if (deleteResponse.success) {
                        logResults('cleanup-results', `Assignment deleted: ${deleteResponse.data.message}`);
                        testResults.cleanup = true;
                        updateTestStatus('test5', 'pass');
                        logResults('cleanup-results', 'Cleanup test PASSED');
                    } else {
                        throw new Error(deleteResponse.data?.message || 'Failed to delete assignment');
                    }
                } else {
                    logResults('cleanup-results', 'No assignments found to delete - creating one first...');
                    // You might want to create an assignment first, then delete it
                    testResults.cleanup = true;
                    updateTestStatus('test5', 'pass');
                    logResults('cleanup-results', 'Cleanup test PASSED (no assignments to clean up)');
                }
                
            } catch (error) {
                testResults.cleanup = false;
                updateTestStatus('test5', 'fail');
                logResults('cleanup-results', `Cleanup test FAILED: ${error.message}`, true);
            }
            
            checkOverallProgress();
        }

        function checkOverallProgress() {
            const allPassed = Object.values(testResults).every(result => result === true);
            const anyTested = Object.values(testResults).some(result => result !== false);
            
            if (allPassed && anyTested) {
                document.getElementById('final-status').style.display = 'block';
            }
        }

        // Auto-start schema test on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ Phase 2D Testing Console loaded');
            setTimeout(testDatabaseSchema, 1000);
        });
    </script>
</body>
</html>