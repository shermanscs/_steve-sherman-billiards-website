<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challenge Event Participants Admin - Steve Sherman Billiards</title>
    
    <!-- Cache busting meta tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .logo {
            width: 50px;
            height: 50px;
            margin-right: 15px;
        }

        .brand-text h2 {
            font-size: 1em;
            margin: 0;
            color: #333;
            font-weight: 600;
            line-height: 1.2;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px 0;
            border-bottom: 2px solid #f0f0f0;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .event-selector {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .event-selector h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.3em;
        }

        .selector-controls {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
            flex: 1;
        }

        .form-label {
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 0.9em;
        }

        .form-select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .event-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .event-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .event-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .event-detail {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.8em;
            color: #666;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .detail-value {
            font-size: 0.9em;
            color: #333;
        }

        .participants-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .participants-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .panel-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .participant-count {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .add-participant-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .participant-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .participant-item:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .participant-info {
            display: flex;
            flex-direction: column;
        }

        .participant-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .participant-email {
            font-size: 0.8em;
            color: #666;
        }

        .participant-meta {
            font-size: 0.7em;
            color: #999;
            margin-top: 2px;
        }

        .available-users {
            background: #f8f9fa;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 6px;
            background: white;
            transition: all 0.3s ease;
        }

        .user-item:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .user-email {
            font-size: 0.7em;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .cache-info {
            display: none; /* Hidden cache indicator */
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }

            .nav-bar {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .nav-buttons {
                justify-content: center;
            }

            .selector-controls {
                flex-direction: column;
            }

            .participants-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .event-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <img src="images/logo.png" alt="Steve Sherman Billiards Logo" class="logo">
                <div class="brand-text">
                    <h2>Steve Sherman Billiards Training System</h2>
                </div>
            </div>
            <h1>Challenge Event Participants Admin</h1>
            <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                Version 2.1.0 - Enhanced Participant Management
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-bar">
            <div class="nav-buttons">
                <a href="challenge-event-admin-portal.html" class="btn btn-secondary">
                    ‚Üê Back to Events
                </a>
                <button id="refreshBtn" class="btn btn-secondary">
                    üîÑ Refresh
                </button>
                <button id="clearCacheBtn" class="btn btn-secondary">
                    üóëÔ∏è Clear Cache
                </button>
            </div>
        </div>

        <!-- Event Selector -->
        <div class="event-selector">
            <h3>üìÖ Select Challenge Event</h3>
            <div class="selector-controls">
                <div class="form-group">
                    <label for="eventSelect" class="form-label">Choose Event</label>
                    <select id="eventSelect" class="form-select">
                        <option value="">Select an event...</option>
                    </select>
                </div>
                <button id="loadEventBtn" class="btn btn-primary" disabled>
                    Load Event
                </button>
            </div>
        </div>

        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- Event Information -->
        <div id="eventInfo" class="event-info" style="display: none;">
            <div class="event-title" id="eventTitle"></div>
            <div class="event-details" id="eventDetails"></div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Loading participants...</p>
        </div>

        <!-- Participants Management -->
        <div id="participantsSection" class="participants-section" style="display: none;">
            <!-- Current Participants -->
            <div class="participants-panel">
                <div class="panel-header">
                    <h3 class="panel-title">üë• Current Participants</h3>
                    <span class="participant-count" id="participantCount">0</span>
                </div>
                <div id="currentParticipants" class="participant-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <p>No participants enrolled yet</p>
                    </div>
                </div>
            </div>

            <!-- Available Users -->
            <div class="participants-panel available-users">
                <div class="panel-header">
                    <h3 class="panel-title">‚ûï Add Participants</h3>
                    <span class="participant-count" id="availableCount">0</span>
                </div>
                <div id="availableUsers" class="participant-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>Loading available users...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cache info display -->
    <div class="cache-info" id="cacheInfo">
        Cache: <span id="cacheTimestamp"></span>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://steveshermanbilliards.com/drill-api.php';

        // Cache busting configuration
        const CACHE_CONFIG = {
            version: Date.now(),
            forceRefresh: true,
            maxAge: 0
        };

        // Global state
        let currentEvents = [];
        let currentEventId = null;
        let currentParticipants = [];
        let availableUsers = [];
        let allUsers = [];

        // ========================================
        // CACHE BUSTING UTILITIES
        // ========================================

        function generateCacheBuster() {
            return `cb=${Date.now()}&r=${Math.random().toString(36).substr(2, 9)}`;
        }

        function addCacheBusting(url) {
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}${generateCacheBuster()}`;
        }

        function clearBrowserCache() {
            try {
                if (typeof sessionStorage !== 'undefined') {
                    sessionStorage.clear();
                }
                
                if (typeof localStorage !== 'undefined') {
                    localStorage.clear();
                }
                
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                        });
                    });
                }
                
                console.log('üóëÔ∏è Browser cache cleared');
                showAlert('Cache cleared successfully! Page will reload.', 'success');
                
                setTimeout(() => {
                    window.location.reload(true);
                }, 1000);
                
            } catch (error) {
                console.error('Error clearing cache:', error);
                showAlert('Cache clearing failed, but page will reload anyway.', 'info');
                setTimeout(() => {
                    window.location.reload(true);
                }, 1000);
            }
        }

        function updateCacheDisplay() {
            const timestamp = document.getElementById('cacheTimestamp');
            if (timestamp) {
                timestamp.textContent = new Date().toLocaleTimeString();
            }
        }

        // ========================================
        // ENHANCED API HELPER FUNCTION
        // ========================================

        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const url = addCacheBusting(`${API_BASE_URL}/${endpoint}`);
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    cache: 'no-store'
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                console.log('üåê API Request:', method, url, data);
                
                const response = await fetch(url, options);
                
                console.log('üì° HTTP Response Status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('üìÑ API Response:', result);
                
                // Handle API responses that indicate "no data found" as success
                if (!result.success) {
                    // Check if it's just a "no participants found" case
                    if (result.message && (
                        result.message.includes('No participants') || 
                        result.message.includes('not found') ||
                        result.message.includes('no data')
                    )) {
                        console.log('‚ÑπÔ∏è API returned "no data" - treating as empty result');
                        return { success: true, data: [] };
                    }
                    throw new Error(result.message || 'API request failed');
                }
                
                return result;
            } catch (error) {
                console.error('‚ùå API Error:', error);
                throw error;
            }
        }

        // ========================================
        // INITIALIZATION
        // ========================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üë• Challenge Event Participants Page Loaded with Cache Busting');
            updateCacheDisplay();
            initializeApp();
        });

        async function initializeApp() {
            try {
                console.log('üöÄ Starting app initialization...');
                
                // Check if event ID was passed in URL
                const urlParams = new URLSearchParams(window.location.search);
                const eventIdParam = urlParams.get('event_id');
                
                console.log('üîç URL params:', { event_id: eventIdParam, type: typeof eventIdParam });

                // Load initial data
                console.log('üìä Loading initial data...');
                await Promise.all([
                    loadEvents(),
                    loadUsers()
                ]);
                console.log('‚úÖ Initial data loaded');

                setupEventListeners();

                // If event ID was provided, select it automatically
                if (eventIdParam) {
                    const eventId = parseInt(eventIdParam);
                    console.log('üéØ Processing event ID:', { original: eventIdParam, parsed: eventId });
                    console.log('üìã Available events after loading:', currentEvents.map(e => ({
                        id: e.id, 
                        type: typeof e.id, 
                        title: e.title,
                        matches_exact: e.id === eventId,
                        matches_loose: e.id == eventId
                    })));
                    
                    // Give a longer delay to ensure everything is ready
                    setTimeout(async () => {
                        try {
                            const eventSelect = document.getElementById('eventSelect');
                            console.log('üîç Looking for event with ID:', eventId);
                            
                            // Try multiple ways to find the event
                            const eventExists = currentEvents.find(e => e.id == eventId) || 
                                              currentEvents.find(e => e.id === eventId) ||
                                              currentEvents.find(e => parseInt(e.id) === eventId);
                            
                            console.log('üîç Event search result:', eventExists);
                            
                            if (eventExists) {
                                console.log('‚úÖ Found event:', eventExists);
                                eventSelect.value = eventExists.id;
                                handleEventSelection();
                                await loadSelectedEvent();
                                // Removed success message - just load silently
                            } else {
                                console.error('‚ùå Event ID not found in available events');
                                console.error('   Searched for:', eventId, typeof eventId);
                                console.error('   Available IDs:', currentEvents.map(e => `${e.id} (${typeof e.id})`));
                                showAlert(`Event ID ${eventId} not found. Available events have been loaded - please select from the dropdown.`, 'error');
                                
                                // Also populate the dropdown to help user see available events
                                populateEventSelect();
                            }
                        } catch (error) {
                            console.error('üí• Error in auto-selection:', error);
                            showAlert('Error loading event. Please select manually from the dropdown.', 'error');
                        }
                    }, 250); // Longer delay
                }

                updateCacheDisplay();
                console.log('üèÅ App initialization complete');

            } catch (error) {
                console.error('üí• Failed to initialize app:', error);
                showAlert('Failed to load application data: ' + error.message, 'error');
            }
        }

        function setupEventListeners() {
            document.getElementById('eventSelect').addEventListener('change', handleEventSelection);
            document.getElementById('loadEventBtn').addEventListener('click', loadSelectedEvent);
            document.getElementById('refreshBtn').addEventListener('click', () => refreshData(true));
            document.getElementById('clearCacheBtn').addEventListener('click', clearBrowserCache);

            // Auto-refresh events
            window.addEventListener('focus', function() {
                console.log('üîÑ Window focused - checking for updates');
                refreshData(false);
            });

            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    console.log('üîÑ Page visible again - checking for updates');
                    refreshData(false);
                }
            });
        }

        // ========================================
        // DATA LOADING FUNCTIONS (WITH CACHE BUSTING)
        // ========================================

        async function loadEvents() {
            try {
                console.log('üìä Loading events with cache busting...');
                const response = await apiRequest('challenge-events');
                currentEvents = response.data || [];
                console.log('üìä Raw events loaded:', currentEvents.length);
                console.log('üìä Event details:', currentEvents.map(e => ({
                    id: e.id,
                    type: typeof e.id,
                    title: e.title,
                    series: e.series_name
                })));
                
                populateEventSelect();
                console.log(`‚úÖ Loaded ${currentEvents.length} events`);
            } catch (error) {
                console.error('Failed to load events:', error);
                currentEvents = [];
                throw error;
            }
        }

        async function loadUsers() {
            try {
                console.log('üë• Loading users with cache busting...');
                const response = await apiRequest('users');
                allUsers = response.data || [];
                
                // Log user structure to understand the data
                console.log('üë• Raw users loaded:', allUsers.length);
                if (allUsers.length > 0) {
                    console.log('üë• Sample user structure:', Object.keys(allUsers[0]));
                    console.log('üë• First user example:', allUsers[0]);
                }
                
                // Filter only players for event participation
                availableUsers = allUsers.filter(user => user.user_type === 'player');
                console.log(`‚úÖ Loaded ${allUsers.length} users (${availableUsers.length} players)`);
                
                // Log available users structure
                console.log('üéØ Available players:', availableUsers.map(u => ({
                    id: u.id,
                    display_name: u.display_name,
                    name: u.name,
                    username: u.username,
                    email: u.email,
                    user_type: u.user_type
                })));
                
            } catch (error) {
                console.error('Failed to load users:', error);
                allUsers = [];
                availableUsers = [];
                throw error;
            }
        }

        async function loadEventParticipants(eventId) {
            try {
                console.log(`üë• Loading participants for event ${eventId} with cache busting...`);
                const response = await apiRequest(`challenge-participants?event_id=${eventId}`);
                
                // Handle case where no participants exist yet
                currentParticipants = response.data || [];
                
                console.log(`‚úÖ Loaded ${currentParticipants.length} participants for event ${eventId}`);
                if (currentParticipants.length === 0) {
                    console.log('‚ÑπÔ∏è No participants found - this is normal for new events');
                }
                
                renderParticipants();
                renderAvailableUsers();
                
            } catch (error) {
                console.error('Failed to load participants:', error);
                
                // If it's a 404 or "no participants found" error, that's actually OK
                if (error.message.includes('404') || error.message.includes('not found') || error.message.includes('No participants')) {
                    console.log('‚ÑπÔ∏è No participants found for this event yet - initializing empty list');
                    currentParticipants = [];
                    renderParticipants();
                    renderAvailableUsers();
                } else {
                    // Only show error for actual API problems
                    console.error('üí• Real API error occurred:', error);
                    currentParticipants = [];
                    renderParticipants();
                    renderAvailableUsers();
                    showAlert('Warning: Could not load participants. You can still add new participants.', 'info');
                }
            }
        }

        async function refreshData(isManual = true) {
            const refreshBtn = document.getElementById('refreshBtn');
            
            if (isManual) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'üîÑ Refreshing...';
            }
            
            try {
                console.log(`üîÑ ${isManual ? 'Manual' : 'Automatic'} refresh triggered...`);
                
                CACHE_CONFIG.version = Date.now();
                
                await Promise.all([
                    loadEvents(),
                    loadUsers()
                ]);

                if (currentEventId) {
                    await loadEventParticipants(currentEventId);
                }

                updateCacheDisplay();

                if (isManual) {
                    showAlert('Data refreshed successfully!', 'success');
                }
            } catch (error) {
                showAlert('Failed to refresh data: ' + error.message, 'error');
            } finally {
                if (isManual) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'üîÑ Refresh';
                }
            }
        }

        // ========================================
        // UI POPULATION FUNCTIONS
        // ========================================

        function populateEventSelect() {
            const select = document.getElementById('eventSelect');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">Select an event...</option>';
            
            // Sort events by date (newest first)
            const sortedEvents = [...currentEvents].sort((a, b) => new Date(b.start_date) - new Date(a.start_date));
            
            console.log('üìã Populating event select with', sortedEvents.length, 'events');
            
            sortedEvents.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                const startDate = new Date(event.start_date).toLocaleDateString();
                option.textContent = `${event.series_name} - ${event.title} (${startDate})`;
                select.appendChild(option);
                console.log(`   üìù Added event: ID=${event.id}, Title="${event.title}"`);
            });
            
            // Restore selection if still valid
            if (currentValue && currentEvents.find(e => e.id == currentValue)) {
                select.value = currentValue;
                handleEventSelection();
            }
        }

        function handleEventSelection() {
            const select = document.getElementById('eventSelect');
            const loadBtn = document.getElementById('loadEventBtn');
            
            loadBtn.disabled = !select.value;
        }

        async function loadSelectedEvent() {
            const eventId = document.getElementById('eventSelect').value;
            console.log('üéØ loadSelectedEvent called with:', { eventId, type: typeof eventId });
            
            if (!eventId) {
                console.log('‚ùå No event ID provided');
                return;
            }

            // Convert to number for comparison
            const numericEventId = parseInt(eventId);
            currentEventId = numericEventId;
            
            console.log('üîç Looking for event:', { original: eventId, numeric: numericEventId });
            console.log('üîç Available events:', currentEvents.map(e => ({
                id: e.id, 
                type: typeof e.id,
                matches: e.id == numericEventId
            })));
            
            const event = currentEvents.find(e => e.id == numericEventId);
            
            if (!event) {
                console.error('‚ùå Selected event not found:', { 
                    searchedFor: numericEventId, 
                    availableIds: currentEvents.map(e => e.id) 
                });
                showAlert('Selected event not found', 'error');
                return;
            }

            console.log('‚úÖ Found event:', event);

            // Show loading state
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('participantsSection').style.display = 'none';
            document.getElementById('eventInfo').style.display = 'none';

            try {
                // Load participants for this event
                await loadEventParticipants(currentEventId);
                
                // Display event information
                displayEventInfo(event);
                
                // Show participants section
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('participantsSection').style.display = 'grid';
                document.getElementById('eventInfo').style.display = 'block';

            } catch (error) {
                console.error('Failed to load event details:', error);
                showAlert('Failed to load event details: ' + error.message, 'error');
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        function displayEventInfo(event) {
            document.getElementById('eventTitle').textContent = `${event.series_name} - ${event.title}`;
            
            const startDate = new Date(event.start_date).toLocaleDateString();
            const endDate = new Date(event.end_date).toLocaleDateString();
            
            document.getElementById('eventDetails').innerHTML = `
                <div class="event-detail">
                    <span class="detail-label">Status</span>
                    <span class="detail-value" style="text-transform: capitalize; color: ${getStatusColor(event.status)}">${event.status}</span>
                </div>
                <div class="event-detail">
                    <span class="detail-label">Start Date</span>
                    <span class="detail-value">${startDate}</span>
                </div>
                <div class="event-detail">
                    <span class="detail-label">End Date</span>
                    <span class="detail-value">${endDate}</span>
                </div>
                <div class="event-detail">
                    <span class="detail-label">Max Attempts</span>
                    <span class="detail-value">${event.max_attempts}</span>
                </div>
            `;
        }

        function getStatusColor(status) {
            const colors = {
                scheduled: '#1976d2',
                active: '#2e7d32',
                complete: '#7b1fa2',
                cancelled: '#c62828'
            };
            return colors[status] || '#666';
        }

        function renderParticipants() {
            const container = document.getElementById('currentParticipants');
            const countElement = document.getElementById('participantCount');
            
            countElement.textContent = currentParticipants.length;
            
            if (currentParticipants.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <p>No participants enrolled yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentParticipants.map(participant => `
                <div class="participant-item">
                    <div class="participant-info">
                        <div class="participant-name">${escapeHtml(participant.user_name)}</div>
                        <div class="participant-email">${escapeHtml(participant.user_email)}</div>
                        <div class="participant-meta">
                            Enrolled: ${new Date(participant.enrolled_date).toLocaleDateString()}
                            by ${escapeHtml(participant.enrolled_by_name)}
                        </div>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removeParticipant(${participant.id})">
                        Remove
                    </button>
                </div>
            `).join('');
        }

        function renderAvailableUsers() {
            const container = document.getElementById('availableUsers');
            const countElement = document.getElementById('availableCount');
            
            // Filter out users who are already participants
            const participantUserIds = currentParticipants.map(p => parseInt(p.user_id));
            console.log('üö´ Excluding participant user IDs:', participantUserIds);
            
            const available = availableUsers.filter(user => {
                const isAlreadyParticipant = participantUserIds.includes(parseInt(user.id));
                if (isAlreadyParticipant) {
                    console.log(`üö´ Filtering out user ${user.id} (already participant)`);
                }
                return !isAlreadyParticipant;
            });
            
            console.log(`üìä Available users: ${available.length} of ${availableUsers.length} total players`);
            
            countElement.textContent = available.length;
            
            if (available.length === 0) {
                if (availableUsers.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üë§</div>
                            <p>No players available</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚úÖ</div>
                            <p>All players are already participants</p>
                        </div>
                    `;
                }
                return;
            }
            
            container.innerHTML = available.map(user => {
                // Handle different possible name fields
                const userName = user.display_name || user.name || user.username || `User ${user.id}`;
                const userEmail = user.email || 'No email';
                
                return `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-name">${escapeHtml(userName)}</div>
                            <div class="user-email">${escapeHtml(userEmail)}</div>
                        </div>
                        <button class="btn btn-success btn-small" onclick="addParticipant(${user.id})">
                            Add
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ========================================
        // PARTICIPANT MANAGEMENT FUNCTIONS
        // ========================================

        async function addParticipant(userId) {
            if (!currentEventId) {
                showAlert('No event selected', 'error');
                return;
            }

            console.log('‚ûï Adding participant:', { userId, type: typeof userId, currentEventId });
            console.log('üë• Available users:', allUsers.map(u => ({ id: u.id, display_name: u.display_name, email: u.email })));

            try {
                const data = {
                    event_id: currentEventId,
                    user_id: userId,
                    enrolled_by: 1 // TODO: Replace with actual admin ID from session
                };

                console.log('üì§ Sending participant data:', data);
                await apiRequest('challenge-participants', 'POST', data);
                
                // Find the user with better error handling
                const user = allUsers.find(u => u.id == userId);
                console.log('üîç Found user:', user);
                
                if (user) {
                    // Handle different possible name fields
                    const userName = user.display_name || user.name || user.username || user.email || `User ${userId}`;
                    showAlert(`${userName} added to event successfully!`, 'success');
                } else {
                    console.warn('‚ö†Ô∏è User not found in allUsers array for ID:', userId);
                    showAlert('Participant added successfully!', 'success');
                }
                
                // Reload participants
                await loadEventParticipants(currentEventId);
                updateCacheDisplay();
                
            } catch (error) {
                console.error('Failed to add participant:', error);
                showAlert('Failed to add participant: ' + error.message, 'error');
            }
        }

        async function removeParticipant(participantId) {
            const participant = currentParticipants.find(p => p.id === participantId);
            if (!participant) {
                showAlert('Participant not found', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to remove ${participant.user_name} from this event?`)) {
                return;
            }

            try {
                await apiRequest(`challenge-participants/${participantId}`, 'DELETE');
                
                showAlert(`${participant.user_name} removed from event successfully!`, 'success');
                
                // Reload participants
                await loadEventParticipants(currentEventId);
                updateCacheDisplay();
                
            } catch (error) {
                console.error('Failed to remove participant:', error);
                showAlert('Failed to remove participant: ' + error.message, 'error');
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // PAGE LIFECYCLE CACHE BUSTING
        // ========================================

        // Periodic cache busting (every 5 minutes)
        setInterval(() => {
            console.log('‚è∞ Periodic refresh triggered');
            refreshData(false);
        }, 5 * 60 * 1000);

        // Force fresh load on page reload
        window.addEventListener('beforeunload', function() {
            CACHE_CONFIG.version = Date.now();
        });

        console.log('üë• Challenge Event Participants Script Loaded with Enhanced Cache Busting');
        console.log('üîß Cache busting features:');
        console.log('   - HTTP cache headers');
        console.log('   - URL cache busting parameters');
        console.log('   - Browser storage clearing');
        console.log('   - Automatic refresh on focus/visibility');
        console.log('   - Periodic refresh every 5 minutes');
        console.log('   - Manual cache clear button');
        console.log('   - Event ID auto-loading from URL');
    </script>
</body>
</html>