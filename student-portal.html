<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - Steve Sherman Billiards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 800px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        .logo {
            width: 60px;
            height: 60px;
            margin-right: 15px;
        }

        .brand-text {
            text-align: left;
            flex: 1;
        }

        .brand-text h2 {
            font-size: 1.1em;
            margin: 0;
            color: #333;
            font-weight: 600;
            line-height: 1.2;
        }

        .logo-top-left {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            z-index: 1000;
        }

        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        .dashboard-logo {
            width: 60px;
            height: 60px;
            margin-right: 15px;
            border-radius: 0 !important;
            box-shadow: none !important;
            background: none !important;
            border: none !important;
        }

        .dashboard-brand-text {
            text-align: left;
        }

        .dashboard-brand-text h1 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dashboard-brand-text p {
            color: #666;
            font-size: 1.1em;
            margin: 0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        /* LOGIN SCREEN STYLES */
        .login-screen {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 1.1em;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .login-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            animation: fadeIn 0.3s ease;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .login-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(40, 167, 69, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(40, 167, 69, 0.3);
            font-size: 14px;
            color: #155724;
            text-align: center;
        }

        /* DASHBOARD STYLES */
        .dashboard-screen {
            display: none;
        }

        .user-info {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-details {
            color: #333;
            font-weight: 600;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .card-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .card-description {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .drill-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .drill-card .card-title,
        .drill-card .card-description {
            color: white;
        }

        .reports-card {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }

        .reports-card .card-title,
        .reports-card .card-description {
            color: white;
        }

        /* Training Programs Card Styles */
        .training-programs-card {
            background: linear-gradient(135deg, #9c27b0 0%, #e91e63 100%);
            color: white;
            position: relative;
        }

        .training-programs-card .card-title,
        .training-programs-card .card-description {
            color: white;
        }

        .new-feature-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }

        /* Progress indicators */
        .progress-summary {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 0.9em;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
            margin: 5px 0;
        }

        .progress-fill {
            height: 100%;
            background: rgba(255,255,255,0.8);
            transition: width 0.3s ease;
        }

        .assignment-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(45deg, #ff4757, #ff3742);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.75em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4);
            animation: pulse 2s infinite;
            z-index: 10;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .card-with-badge {
            position: relative;
        }

        .card-disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
            position: relative;
        }

        .card-disabled:hover {
            transform: none !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1) !important;
            border-color: transparent !important;
        }

        .coming-soon {
            opacity: 0.7;
            cursor: not-allowed !important;
            position: relative;
        }

        .coming-soon:hover {
            transform: none !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1) !important;
            border-color: transparent !important;
        }

        .coming-soon::after {
            content: "Coming Soon";
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .welcome-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .welcome-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            color: #666;
            font-size: 1em;
        }

        .stats-summary {
            background: rgba(40, 167, 69, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-summary h3 {
            color: #155724;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 600;
            color: #28a745;
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                width: calc(100% - 20px);
                padding: 30px 20px;
                max-width: none;
            }

            .header h1 {
                font-size: 2em;
            }

            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .dashboard-card {
                min-height: 180px;
                padding: 25px 15px;
            }

            .card-icon {
                font-size: 2.5em;
                margin-bottom: 12px;
            }

            .card-title {
                font-size: 1.1em;
                margin-bottom: 8px;
            }

            .card-description {
                font-size: 0.85em;
            }

            .user-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .dashboard-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .dashboard-brand-text {
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .dashboard-card {
                min-height: 160px;
                padding: 20px 12px;
            }

            .card-icon {
                font-size: 2.2em;
                margin-bottom: 10px;
            }

            .card-title {
                font-size: 1em;
                margin-bottom: 6px;
            }

            .card-description {
                font-size: 0.8em;
            }

            .header-text h1 {
                font-size: 1.5em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- LOGIN SCREEN -->
        <div id="loginScreen" class="login-screen">
            <div class="header">
                <div class="header-top">
                    <img src="images/logo.png" alt="Steve Sherman Billiards Logo" class="logo">
                    <div class="brand-text">
                        <h2>Steve Sherman Billiards Training System</h2>
                    </div>
                </div>
                <h1>Student Portal</h1>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="email" class="form-label">Email Address:</label>
                    <input type="email" id="email" name="email" class="form-input" required 
                           placeholder="Enter your email address">
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">
                    Login to Student Portal
                </button>
            </form>
            
            <div id="loginError" class="error-message"></div>
            
            <div class="login-info">
                <strong>Student Access</strong><br>
                Use your registered email address to access your training dashboard
                <br><small style="color: #999; margin-top: 10px; display: block;">Version 3.2 - Training Programs Integration</small>
            </div>
        </div>

        <!-- DASHBOARD SCREEN -->
        <div id="dashboardScreen" class="dashboard-screen">
            <div class="header">
                <div class="header-top">
                    <img src="images/logo.png" alt="Steve Sherman Billiards Logo" class="logo">
                    <div class="brand-text">
                        <h2>Steve Sherman Billiards Training System</h2>
                    </div>
                </div>
                <h1>Student Dashboard</h1>
            </div>

            <div class="user-info">
                <div class="user-details">
                    <span>Welcome, <strong id="currentStudent"></strong></span><br>
                    <small>Last login: <span id="lastLogin"></span> | Version 3.2</small>
                </div>
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>

            <div class="stats-summary">
                <h3>Your Progress</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalScores">--</div>
                        <div class="stat-label">Total Scores</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgScore">--%</div>
                        <div class="stat-label">Average</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="assignedDrills">--</div>
                        <div class="stat-label">Assigned</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="recentActivity">--</div>
                        <div class="stat-label">This Week</div>
                    </div>
                </div>
            </div>

            <div class="welcome-section">
                <h2 class="welcome-title">Training Dashboard</h2>
                <p class="welcome-subtitle">Track your progress and practice with assigned drills</p>
            </div>

            <div class="dashboard-grid">
                <!-- Drill App Card -->
                <div class="dashboard-card drill-card" onclick="openDrillApp()">
                    <span class="card-icon">🎯</span>
                    <h3 class="card-title">Practice Drills</h3>
                    <p class="card-description">Start practicing and submit your drill scores</p>
                </div>

                <!-- Reports Card -->
                <div class="dashboard-card reports-card" onclick="openReportPortal()">
                    <span class="card-icon">📊</span>
                    <h3 class="card-title">Progress Reports</h3>
                    <p class="card-description">View your improvement and statistics</p>
                </div>

                <!-- NEW: Training Programs Card -->
                <div class="dashboard-card training-programs-card" onclick="openMyTrainingPrograms()">
                    <span class="card-icon">📚</span>
                    <h3 class="card-title">My Training Programs</h3>
                    <p class="card-description">View your assigned training programs and track your progress through structured learning paths</p>
                    <div class="new-feature-badge">NEW</div>
                    
                    <!-- Progress Summary (optional) -->
                    <div class="progress-summary" id="programsProgress" style="display: none;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Overall Progress</span>
                            <span id="overallProgressText">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="overallProgressBar" style="width: 0%"></div>
                        </div>
                        <small id="programsSummary">No programs assigned yet</small>
                    </div>
                </div>

                <!-- Training Journal Button -->
                <div class="dashboard-card" onclick="openJournal()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                    <span class="card-icon">📔</span>
                    <h3 class="card-title" style="color: white;">Training Journal</h3>
                    <p class="card-description" style="color: white;">Record your thoughts and progress notes</p>
                </div>

                <!-- Events Card -->
                <div class="dashboard-card" onclick="openEvents()" style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%); color: white;">
                    <span class="card-icon">📅</span>
                    <h3 class="card-title" style="color: white;">My Events</h3>
                    <p class="card-description" style="color: white;">View current, past and future events</p>
                </div>

                <!-- Training Plan Card -->
                <div class="dashboard-card" onclick="openTrainingPlan()" style="background: linear-gradient(135deg, #17a2b8 0%, #007bff 100%); color: white;">
                    <span class="card-icon">📋</span>
                    <h3 class="card-title" style="color: white;">My Training Plan</h3>
                    <p class="card-description" style="color: white;">View your personalized training schedule</p>
                </div>

                <!-- Assignments Card -->
                <div id="assignmentsCard" class="dashboard-card" onclick="openAssignments()" style="background: linear-gradient(135deg, #fd7e14 0%, #ff6b6b 100%); color: white;">
                    <span class="card-icon">📋</span>
                    <h3 class="card-title" style="color: white;">My Assignments</h3>
                    <p class="card-description" style="color: white;">View drills assigned by your coach</p>
                </div>

                <!-- Live Coaching Card -->
                <div class="dashboard-card" onclick="openLiveCoaching()" style="background: linear-gradient(135deg, #8e44ad 0%, #3498db 100%); color: white;">
                    <span class="card-icon">📹</span>
                    <h3 class="card-title" style="color: white;">Live Coaching</h3>
                    <p class="card-description" style="color: white;">Connect with your coach online</p>
                </div>

                <!-- Skill Assessments Card -->
                <div class="dashboard-card coming-soon">
                    <span class="card-icon">📝</span>
                    <h3 class="card-title">Skill Assessments</h3>
                    <p class="card-description">Take skill evaluation tests</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://steveshermanbilliards.com/drill-api.php';

        // Session management
        let currentSession = null;

        // ========================================
        // API HELPER FUNCTION
        // ========================================

        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                console.log('🌐 API Request:', method, `${API_BASE_URL}/${endpoint}`, data);
                
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, options);
                
                console.log('📡 HTTP Response Status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('📄 API Response:', result);
                
                if (!result.success) {
                    throw new Error(result.message || 'API request failed');
                }
                
                return result;
            } catch (error) {
                console.error('❌ API Error:', error);
                throw error;
            }
        }

        // ========================================
        // LOGIN FUNCTIONALITY
        // ========================================

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleLogin();
        });

        document.getElementById('logoutBtn').addEventListener('click', handleLogout);

        // Handle Enter key on email field
        document.getElementById('email').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });

        async function handleLogin() {
            const email = document.getElementById('email').value.trim();
            const loginBtn = document.getElementById('loginBtn');

            console.log('🚀 Starting student login process');
            console.log('📝 Email:', email);

            if (!email) {
                showLoginError('Please enter your email address.');
                return;
            }

            // Disable login button during authentication
            loginBtn.disabled = true;
            loginBtn.textContent = 'Authenticating...';

            try {
                console.log('🔐 Attempting student authentication...');
                
                // Call the regular login API (for students)
                const response = await apiRequest('login', 'POST', {
                    email: email
                });

                console.log('✅ Authentication API call completed');
                console.log('📄 Full Response:', JSON.stringify(response, null, 2));
                
                // Extract user data from response
                let userData = null;
                
                if (response.user) {
                    console.log('👤 Found user data in response.user');
                    userData = response.user;
                } else if (response.data && response.data.user) {
                    console.log('👤 Found user data in response.data.user');
                    userData = response.data.user;
                } else if (response.data) {
                    console.log('👤 Found user data in response.data');
                    userData = response.data;
                } else {
                    console.error('❌ No user data found in response');
                    console.error('❌ Response keys:', Object.keys(response));
                    throw new Error('No user data found in server response');
                }
                
                console.log('👤 User Data:', JSON.stringify(userData, null, 2));
                
                // Create session
                const sessionData = {
                    userId: userData.id || 0,
                    email: userData.email || email,
                    name: userData.name || userData.display_name || email,
                    type: userData.type || 'student',
                    loginTime: new Date(),
                    sessionId: generateSessionId(),
                    token: response.token || (response.data && response.data.token) || 'no-token'
                };
                
                console.log('💾 Session Data Created:', JSON.stringify(sessionData, null, 2));
                
                currentSession = sessionData;

                // Store session
                try {
                    sessionStorage.setItem('studentSession', JSON.stringify(currentSession));
                    console.log('💾 Session saved to storage');
                } catch (e) {
                    console.log('⚠️ Session storage not available, using memory session');
                }

                // Load user stats and show dashboard
                await loadUserStats();
                await loadTrainingProgramsSummary();
                showDashboard();

            } catch (error) {
                console.error('❌ Authentication failed:', error);
                showLoginError(error.message || 'Authentication failed. Please check your email address.');
            } finally {
                // Re-enable login button
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login to Student Portal';
            }
        }

        function generateSessionId() {
            return Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear session
                currentSession = null;
                try {
                    sessionStorage.removeItem('studentSession');
                    sessionStorage.removeItem('reportSession');
                    sessionStorage.removeItem('drillAppSession');
                } catch (e) {
                    console.log('Session storage not available');
                }

                // Reset form
                document.getElementById('loginForm').reset();
                
                // Show login screen
                document.getElementById('dashboardScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'block';
            }
        }

        function showDashboard() {
            try {
                console.log('🏠 Showing student dashboard');
                
                // Update dashboard with user info
                const studentNameElement = document.getElementById('currentStudent');
                const lastLoginElement = document.getElementById('lastLogin');
                
                if (studentNameElement) {
                    const displayName = currentSession && currentSession.name ? currentSession.name : 'Student';
                    studentNameElement.textContent = displayName;
                }
                
                if (lastLoginElement) {
                    const loginTime = currentSession && currentSession.loginTime ? currentSession.loginTime.toLocaleString() : 'Unknown';
                    lastLoginElement.textContent = loginTime;
                }

                // Switch to dashboard
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboardScreen').style.display = 'block';
                
                console.log('🏠 Student dashboard displayed successfully');
                
            } catch (error) {
                console.error('❌ Error in showDashboard:', error);
                showLoginError('Error displaying dashboard: ' + error.message);
            }
        }

        // ========================================
        // USER STATS
        // ========================================

        async function loadUserStats() {
            if (!currentSession || !currentSession.userId) {
                console.log('⚠️ No user session for stats');
                return;
            }

            try {
                console.log('📊 Loading user statistics for user ID:', currentSession.userId);
                
                // Load user's scores with explicit user filtering
                const scoresResponse = await apiRequest(`scores?user_id=${currentSession.userId}&limit=100`);
                let scores = scoresResponse.data || scoresResponse || [];
                
                // Additional client-side filtering to ensure only this user's scores
                scores = scores.filter(score => 
                    score.user_id == currentSession.userId || 
                    score.userId == currentSession.userId ||
                    score.student_id == currentSession.userId
                );
                
                // Load user's assignments with explicit user filtering
                const assignmentsResponse = await apiRequest(`assignments?user_id=${currentSession.userId}`);
                let assignments = assignmentsResponse.data || assignmentsResponse || [];
                
                // Additional client-side filtering for assignments
                assignments = assignments.filter(assignment => 
                    assignment.user_id == currentSession.userId || 
                    assignment.userId == currentSession.userId ||
                    assignment.student_id == currentSession.userId
                );
                
                // Filter for active assignments only
                const activeAssignments = assignments.filter(assignment => assignment.is_active == 1);
                
                console.log('📊 Filtered scores for user:', scores.length);
                console.log('📊 Filtered assignments for user:', assignments.length);
                console.log('📊 Active assignments for user:', activeAssignments.length);
                
                // Calculate stats - only for this user's data
                const totalScores = scores.length;
                const avgScore = scores.length > 0 ? 
                    Math.round(scores.reduce((sum, score) => sum + parseFloat(score.percentage || score.score || 0), 0) / scores.length) : 0;
                const assignedDrillsCount = assignments.length;
                
                // Count recent activity (last week) - only this user's scores
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const recentScores = scores.filter(score => {
                    const scoreDate = new Date(score.submitted_at || score.practice_date || score.created_at);
                    return scoreDate > oneWeekAgo;
                }).length;
                
                // Update UI
                document.getElementById('totalScores').textContent = totalScores;
                document.getElementById('avgScore').textContent = avgScore + '%';
                document.getElementById('assignedDrills').textContent = assignedDrillsCount;
                document.getElementById('recentActivity').textContent = recentScores;
                
                // Update assignments card based on active assignments
                updateAssignmentsCard(activeAssignments.length);
                
                console.log('📊 User-specific stats loaded:', { 
                    userId: currentSession.userId,
                    totalScores, 
                    avgScore, 
                    assignedDrillsCount, 
                    activeAssignments: activeAssignments.length,
                    recentScores 
                });
                
            } catch (error) {
                console.error('❌ Error loading user stats:', error);
                // Keep default values on error
                document.getElementById('totalScores').textContent = '--';
                document.getElementById('avgScore').textContent = '--%';
                document.getElementById('assignedDrills').textContent = '--';
                document.getElementById('recentActivity').textContent = '--';
                
                // Disable assignments card on error
                updateAssignmentsCard(0);
            }
        }

        /**
         * Load and display training program progress summary
         * Call this during student portal initialization
         */
        async function loadTrainingProgramsSummary() {
            try {
                const currentStudent = getCurrentStudentData();
                
                if (!currentStudent) {
                    return;
                }
                
                // Load assigned programs (when the API endpoint is ready)
                // const response = await apiRequest(`training-program-assignments?user_id=${currentStudent.id}`);
                // const assignments = response.data || [];
                
                // For now, simulate some data
                const assignments = [
                    { program_name: "Beginner Foundation", progress_percentage: 65 },
                    { program_name: "Cue Ball Control", progress_percentage: 30 }
                ];
                
                if (assignments.length > 0) {
                    const overallProgress = assignments.reduce((sum, a) => sum + (a.progress_percentage || 0), 0) / assignments.length;
                    
                    // Update progress display
                    document.getElementById('overallProgressText').textContent = Math.round(overallProgress) + '%';
                    document.getElementById('overallProgressBar').style.width = overallProgress + '%';
                    document.getElementById('programsSummary').textContent = `${assignments.length} program${assignments.length !== 1 ? 's' : ''} assigned`;
                    document.getElementById('programsProgress').style.display = 'block';
                }
                
            } catch (error) {
                console.error('❌ Error loading training programs summary:', error);
                // Don't show error to user, just log it
            }
        }

        /**
         * Get current student data - adapt this to your existing session management
         */
        function getCurrentStudentData() {
            // This should return the current logged-in student data
            // Adapt this to match your existing session management system
            
            try {
                // Try to get from current session first
                if (currentSession) {
                    return {
                        id: currentSession.userId,
                        name: currentSession.name,
                        email: currentSession.email,
                        type: currentSession.type
                    };
                }
                
                // Try to get from session storage
                const sessionData = sessionStorage.getItem('studentSession');
                if (sessionData) {
                    const session = JSON.parse(sessionData);
                    return {
                        id: session.userId,
                        name: session.name,
                        email: session.email,
                        type: session.type
                    };
                }
                
                // Try to get from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const studentData = urlParams.get('student');
                if (studentData) {
                    return JSON.parse(atob(studentData));
                }
                
                // Return null if no student data found
                return null;
                
            } catch (error) {
                console.error('Error getting student data:', error);
                return null;
            }
        }

        function updateAssignmentsCard(assignmentCount) {
            const assignmentsCard = document.getElementById('assignmentsCard');
            
            if (!assignmentsCard) {
                console.log('⚠️ Assignments card not found');
                return;
            }
            
            console.log('🏷️ Updating assignments card with count:', assignmentCount);
            
            // Remove any existing badges or disabled classes
            assignmentsCard.classList.remove('card-with-badge', 'card-disabled');
            const existingBadge = assignmentsCard.querySelector('.assignment-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            if (assignmentCount > 0) {
                // Enable the card and add badge
                assignmentsCard.classList.add('card-with-badge');
                assignmentsCard.style.cursor = 'pointer';
                assignmentsCard.onclick = openAssignments;
                
                // Create and add the assignment badge
                const badge = document.createElement('div');
                badge.className = 'assignment-badge';
                badge.textContent = assignmentCount > 99 ? '99+' : assignmentCount.toString();
                badge.title = `${assignmentCount} active assignment${assignmentCount === 1 ? '' : 's'}`;
                assignmentsCard.appendChild(badge);
                
                console.log('✅ Assignments card enabled with badge:', assignmentCount);
            } else {
                // Disable the card
                assignmentsCard.classList.add('card-disabled');
                assignmentsCard.style.cursor = 'not-allowed';
                assignmentsCard.onclick = function() {
                    alert('You don\'t have any active assignments yet. Check back later or contact your coach.');
                };
                
                console.log('❌ Assignments card disabled - no active assignments');
            }
        }

        // ========================================
        // NAVIGATION FUNCTIONS
        // ========================================

        /**
         * Open the student's training programs interface
         */
        function openMyTrainingPrograms() {
            console.log('📚 Opening my training programs...');
            
            // Get current student data (adapt this to your existing session management)
            const currentStudent = getCurrentStudentData();
            
            if (!currentStudent) {
                alert('Please login to access your training programs.');
                return;
            }
            
            // Create URL with student data
            const studentData = btoa(JSON.stringify({
                id: currentStudent.id,
                name: currentStudent.name,
                email: currentStudent.email,
                type: 'student'
            }));
            
            // Open training programs interface
            const programsUrl = `student-training-programs.html?student=${studentData}&t=${Date.now()}`;
            console.log('🌐 Opening training programs interface');
            
            window.open(programsUrl, '_blank', 'width=1400,height=900,scrollbars=yes,resizable=yes');
        }

        function openReportPortal() {
            console.log('📊 Opening report portal...');
            console.log('🔍 Current Session:', JSON.stringify(currentSession, null, 2));
            
            if (!currentSession) {
                console.error('❌ No current session found');
                alert('Please login first to access the report portal.');
                return;
            }
            
            // Store current session data that report portal can access
            const reportPortalSession = {
                userId: currentSession.userId,
                name: currentSession.name,
                email: currentSession.email,
                type: currentSession.type,
                token: currentSession.token,
                loginTime: currentSession.loginTime,
                fromPortal: true,
                timestamp: new Date().toISOString()
            };
            
            console.log('💾 Preparing report portal session:', JSON.stringify(reportPortalSession, null, 2));
            
            try {
                // Store session for report portal to pick up
                sessionStorage.setItem('reportSession', JSON.stringify(reportPortalSession));
                console.log('✅ Report portal session stored successfully');
                
                // Also ensure studentSession is available as backup
                sessionStorage.setItem('studentSession', JSON.stringify(currentSession));
                console.log('✅ Student session backup stored');
                
            } catch (e) {
                console.error('❌ Could not prepare report portal session:', e);
                alert('Error preparing session. Please try again.');
                return;
            }
            
            // Create URL with user data as parameters (base64 encoded for safety)
            const userData = btoa(JSON.stringify({
                id: currentSession.userId,
                name: currentSession.name,
                email: currentSession.email,
                type: currentSession.type
            }));
            
            // Open report portal with user data
            const reportPortalUrl = `report-portal.html?user=${userData}&t=${Date.now()}`;
            console.log('🌐 Opening report portal URL');
            
            // Small delay to ensure session is written
            setTimeout(() => {
                window.open(reportPortalUrl, '_blank');
            }, 100);
        }

        function openDrillApp() {
            console.log('🎯 Opening drill app...');
            console.log('🔍 Current Session:', JSON.stringify(currentSession, null, 2));
            
            if (!currentSession) {
                console.error('❌ No current session found');
                alert('Please login first to access the drill app.');
                return;
            }
            
            // Store current session data that drill app can access
            const drillAppSession = {
                userId: currentSession.userId,
                name: currentSession.name,
                email: currentSession.email,
                type: currentSession.type,
                token: currentSession.token,
                loginTime: currentSession.loginTime,
                fromPortal: true,
                timestamp: new Date().toISOString()
            };
            
            console.log('💾 Preparing drill app session:', JSON.stringify(drillAppSession, null, 2));
            
            try {
                // Clear any existing drill app session first
                sessionStorage.removeItem('drillAppSession');
                
                // Store session for drill app to pick up
                sessionStorage.setItem('drillAppSession', JSON.stringify(drillAppSession));
                console.log('✅ Drill app session stored successfully');
                
                // Verify it was stored
                const verifySession = sessionStorage.getItem('drillAppSession');
                console.log('🔍 Verification - stored session:', verifySession);
                
                if (!verifySession) {
                    throw new Error('Session was not stored properly');
                }
                
                // Also ensure studentSession is available as backup
                sessionStorage.setItem('studentSession', JSON.stringify(currentSession));
                console.log('✅ Student session backup stored');
                
            } catch (e) {
                console.error('❌ Could not prepare drill app session:', e);
                alert('Error preparing session. Please try again.');
                return;
            }
            
            // Create URL with user data as parameters (base64 encoded for safety)
            const userData = btoa(JSON.stringify({
                id: currentSession.userId,
                name: currentSession.name,
                email: currentSession.email,
                type: currentSession.type
            }));
            
            // Open drill app with portal parameter, timestamp, and user data
            const drillAppUrl = `drill-app.html?portal=student&user=${userData}&t=${Date.now()}`;
            console.log('🌐 Opening URL with user data');
            
            // Small delay to ensure session is written
            setTimeout(() => {
                window.open(drillAppUrl, '_blank');
            }, 100);
        }

        // SIMPLE JOURNAL FUNCTION
        function openJournal() {
            if (!currentSession) {
                alert('Please login first to access your training journal.');
                return;
            }
            
            const userData = btoa(JSON.stringify({
                id: currentSession.userId,
                name: currentSession.name,
                email: currentSession.email,
                type: currentSession.type
            }));
            
            window.open(`training-journal.html?user=${userData}&t=${Date.now()}`, '_blank');
        }

        // EVENTS FUNCTION
        function openEvents() {
            console.log('📅 Opening events...');
            
            if (!currentSession) {
                alert('Please login first to access your events.');
                return;
            }
            
            // Create URL with user data as parameters (base64 encoded for safety)
            const userData = btoa(JSON.stringify({
                id: currentSession.userId,
                name: currentSession.name,
                email: currentSession.email,
                type: currentSession.type
            }));
            
            // Open events page with user data
            const eventsUrl = `student-events.html?user=${userData}&t=${Date.now()}`;
            console.log('🌐 Opening events page');
            
            // Small delay to ensure session is available
            setTimeout(() => {
                window.open(eventsUrl, '_blank');
            }, 100);
        }

        // ASSIGNMENTS FUNCTION
        function openAssignments() {
            console.log('📋 Opening assignments...');
            
            if (!currentSession) {
                alert('Please login first to access your assignments.');
                return;
            }
            
            // Check if the card is disabled
            const assignmentsCard = document.getElementById('assignmentsCard');
            if (assignmentsCard && assignmentsCard.classList.contains('card-disabled')) {
                console.log('📋 Assignments card is disabled - user has no active assignments');
                return; // Function already handled by onclick override
            }
            
            // Create URL with user data as parameters (base64 encoded for safety)
            const userData = btoa(JSON.stringify({
                id: currentSession.userId,
                name: currentSession.name,
                email: currentSession.email,
                type: currentSession.type
            }));
            
            // Open assignments page with user data
            const assignmentsUrl = `student-drill-assignments.html?user=${userData}&t=${Date.now()}`;
            console.log('🌐 Opening assignments page');
            
            // Small delay to ensure session is available
            setTimeout(() => {
                window.open(assignmentsUrl, '_blank');
            }, 100);
        }

        // TRAINING PLAN FUNCTION (PLACEHOLDER)
        function openTrainingPlan() {
            console.log('📋 Opening training plan...');
            
            if (!currentSession) {
                alert('Please login first to access your training plan.');
                return;
            }
            
            // For now, just show a placeholder alert
            // Later this will be wired to launch the actual training plan screen
            alert('Training Plan feature coming soon! This will show your personalized training schedule.');
            
            console.log('📋 Training plan placeholder activated for user:', currentSession.name);
            
            // When ready to implement, use similar pattern as other functions:
            /*
            const userData = btoa(JSON.stringify({
                id: currentSession.userId,
                name: currentSession.name,
                email: currentSession.email,
                type: currentSession.type
            }));
            
            window.open(`training-plan.html?user=${userData}&t=${Date.now()}`, '_blank');
            */
        }

        // LIVE COACHING FUNCTION (PLACEHOLDER)
        function openLiveCoaching() {
            console.log('📹 Opening live coaching...');
            
            if (!currentSession) {
                alert('Please login first to access live coaching.');
                return;
            }
            
            // For now, just show a placeholder alert
            // Later this will be wired to launch the actual live coaching interface
            alert('Live Coaching feature coming soon! This will allow you to connect with your coach via video call.');
            
            console.log('📹 Live coaching placeholder activated for user:', currentSession.name);
        }

        // ========================================
        // SESSION MANAGEMENT
        // ========================================

        // Check for existing session on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Student Portal DOM Loaded - Version 3.2');
            
            try {
                const savedSession = sessionStorage.getItem('studentSession');
                if (savedSession) {
                    const session = JSON.parse(savedSession);
                    
                    // Check if session is still valid (24 hours)
                    const sessionAge = Date.now() - new Date(session.loginTime).getTime();
                    const maxAge = 24 * 60 * 60 * 1000; // 24 hours
                    
                    if (sessionAge < maxAge) {
                        currentSession = session;
                        Promise.all([loadUserStats(), loadTrainingProgramsSummary()])
                            .then(() => showDashboard());
                    } else {
                        // Session expired
                        sessionStorage.removeItem('studentSession');
                    }
                }
            } catch (e) {
                console.log('Session management not available');
            }
        });

        // ========================================
        // SECURITY ENHANCEMENTS
        // ========================================

        // Prevent back button after logout
        window.addEventListener('pageshow', function(event) {
            if (event.persisted && !currentSession) {
                window.location.reload();
            }
        });

        // Auto-logout after inactivity (30 minutes)
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            if (currentSession) {
                inactivityTimer = setTimeout(() => {
                    alert('Session expired due to inactivity. Please login again.');
                    handleLogout();
                }, 30 * 60 * 1000); // 30 minutes
            }
        }

        // Reset timer on user activity
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, resetInactivityTimer, true);
        });

        console.log('🎱 Student Portal v3.2 - Training Programs Integration');
        console.log('📡 API URL:', API_BASE_URL);
    </script>
</body>
</html>