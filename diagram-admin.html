<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagram Admin - Steve Sherman Billiards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .content {
            padding: 40px;
        }

        .admin-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
        }

        .user-info {
            text-align: right;
            color: #666;
            font-size: 0.9em;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #667eea;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Pagination and Results Info */
        .results-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            color: #666;
            font-size: 0.9em;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .page-size-selector select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Diagrams Grid with Scrolling */
        .diagrams-container {
            position: relative;
        }

        .diagrams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            max-height: 800px;
            overflow-y: auto;
            padding-right: 10px;
            margin-right: -10px;
        }

        /* Custom scrollbar */
        .diagrams-grid::-webkit-scrollbar {
            width: 8px;
        }

        .diagrams-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .diagrams-grid::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .diagrams-grid::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }

        .diagram-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .diagram-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* Enhanced preview to handle both images and vectors */
        .diagram-preview {
            width: 100%;
            height: 220px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            position: relative;
            overflow: hidden;
            padding: 8px;
        }

        .diagram-preview img {
            max-width: calc(100% - 16px);
            max-height: calc(100% - 16px);
            width: auto;
            height: auto;
            object-fit: contain;
            object-position: center;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .diagram-preview svg {
            max-width: calc(100% - 16px);
            max-height: calc(100% - 16px);
            width: auto;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .diagram-preview .no-image {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 2em;
        }

        .diagram-preview .no-image small {
            font-size: 0.4em;
            color: #999;
        }

        .diagram-info {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .diagram-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .diagram-badges {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-type {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-vector {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-image {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge-public {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .badge-private {
            background: #fff3cd;
            color: #856404;
        }

        .diagram-description {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.9em;
            flex-grow: 1;
            line-height: 1.4;
            position: relative;
        }

        .diagram-description.collapsed {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .diagram-description.expanded {
            display: block;
        }

        .read-more-btn {
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            margin-top: 5px;
            text-decoration: underline;
            display: inline-block;
        }

        .read-more-btn:hover {
            color: #5a6fd8;
        }

        .diagram-meta {
            font-size: 0.8em;
            color: #999;
            margin-bottom: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .diagram-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: auto;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Enhanced form for vector data */
        .vector-data-textarea {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .diagram-type-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
        }

        .diagram-type-tab {
            flex: 1;
            padding: 12px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .diagram-type-tab.active {
            background: #667eea;
            color: white;
        }

        .diagram-type-tab:hover:not(.active) {
            background: #e9ecef;
        }

        .diagram-input-section {
            display: none;
        }

        .diagram-input-section.active {
            display: block;
        }

        .file-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .image-preview {
            max-width: 100%;
            max-height: 250px;
            margin-top: 15px;
            border-radius: 8px;
            display: none;
            object-fit: contain;
            border: 1px solid #ddd;
            padding: 4px;
            background: white;
        }

        .vector-preview {
            max-width: 100%;
            max-height: 250px;
            margin-top: 15px;
            border-radius: 8px;
            display: none;
            border: 1px solid #ddd;
            padding: 4px;
            background: white;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ddd;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1001;
            display: none;
            animation: pulse 1.5s infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .content {
                padding: 20px;
            }

            .admin-nav {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .results-info {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            .pagination-controls {
                justify-content: center;
            }

            .diagrams-grid {
                grid-template-columns: 1fr;
                max-height: 600px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .diagram-preview {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Diagram Management</h1>
            <p>Upload images and create vector diagrams</p>
        </div>

        <div class="content">
            <div class="admin-nav">
                <div class="nav-buttons">
                    <a href="drill-admin-portal.html" class="btn btn-secondary">← Back to Admin Portal</a>
                    <button class="btn btn-primary" onclick="loadDiagrams()">🔄 Refresh Data</button>
                    <button class="btn btn-secondary" onclick="debugBlobStorage()">🔧 Debug Storage</button>
                    <button class="btn btn-secondary" onclick="forceRefreshAll()">🚀 Force Refresh All</button>
                </div>
                <div class="user-info">
                    <span id="currentUserDisplay"></span>
                    <br><small>Diagram Admin | Version 3.0 - Vector Support</small>
                </div>
            </div>

            <div class="controls">
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="openUploadModal()">
                        📁 Upload Diagram
                    </button>
                    <button class="btn btn-primary" onclick="openDrawingTool()">
                        🎱 Create Billiard Diagram
                    </button>
                    <select id="typeFilter" class="form-input" style="min-width: 150px;" onchange="filterDiagrams()">
                        <option value="">All Types</option>
                        <option value="drill">Drill Diagrams</option>
                        <option value="journal">Journal</option>
                        <option value="strategy">Strategy</option>
                        <option value="technique">Technique</option>
                        <option value="table_layout">Table Layout</option>
                        <option value="equipment">Equipment</option>
                        <option value="reference">Reference</option>
                        <option value="other">Other</option>
                    </select>
                    <select id="visibilityFilter" class="form-input" style="min-width: 120px;" onchange="filterDiagrams()">
                        <option value="">All Visibility</option>
                        <option value="public">Public</option>
                        <option value="private">Private</option>
                    </select>
                    <select id="formatFilter" class="form-input" style="min-width: 120px;" onchange="filterDiagrams()">
                        <option value="">All Formats</option>
                        <option value="image">Images</option>
                        <option value="vector">Vectors</option>
                    </select>
                    <input type="text" id="searchInput" class="form-input" placeholder="Search diagrams..." style="min-width: 200px;" onkeyup="debounceSearch()">
                </div>
            </div>

            <div id="alertContainer"></div>

            <!-- Results Info and Pagination -->
            <div id="resultsInfo" class="results-info" style="display: none;">
                <div class="pagination-info">
                    <span id="resultsText">Showing 0 of 0 diagrams</span>
                </div>
                <div class="pagination-controls">
                    <div class="page-size-selector">
                        <label>Show:</label>
                        <select id="pageSizeSelect" onchange="changePageSize()">
                            <option value="12">12 per page</option>
                            <option value="24">24 per page</option>
                            <option value="48">48 per page</option>
                            <option value="96">96 per page</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <button class="pagination-btn" id="firstBtn" onclick="goToPage(1)">««</button>
                        <button class="pagination-btn" id="prevBtn" onclick="goToPage(currentPage - 1)">‹</button>
                        <span id="pageNumbers"></span>
                        <button class="pagination-btn" id="nextBtn" onclick="goToPage(currentPage + 1)">›</button>
                        <button class="pagination-btn" id="lastBtn" onclick="goToPage(totalPages)">»»</button>
                    </div>
                </div>
            </div>

            <div class="diagrams-container">
                <div id="diagramsContainer" class="diagrams-grid"></div>
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <h3>No Diagrams Found</h3>
                <p>Upload your first diagram or create a vector diagram to get started</p>
            </div>

            <div id="loadingState" class="loading" style="display: none;">
                Loading diagrams...
            </div>
            
            <!-- Refresh Indicator -->
            <div id="refreshIndicator" class="refresh-indicator">
                🔄 Updating data...
            </div>
        </div>
    </div>

    <!-- Enhanced Upload Modal with Vector Support -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Upload Diagram</h2>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>

            <form id="diagramForm">
                <input type="hidden" id="diagramId">

                <div class="form-group">
                    <label class="form-label">Diagram Name *</label>
                    <input type="text" id="diagramName" class="form-input" required>
                </div>

                <div style="display: flex; gap: 15px;">
                    <div style="flex: 1;">
                        <label class="form-label">Diagram Type *</label>
                        <select id="diagramType" class="form-input" required>
                            <option value="">Select type...</option>
                            <option value="drill">Drill Diagram</option>
                            <option value="journal">Journal Illustration</option>
                            <option value="strategy">Strategy Board</option>
                            <option value="technique">Technique Guide</option>
                            <option value="table_layout">Table Layout</option>
                            <option value="equipment">Equipment Guide</option>
                            <option value="reference">Reference Material</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label class="form-label">Visibility *</label>
                        <select id="diagramVisibility" class="form-input" required>
                            <option value="private">Private (Only You)</option>
                            <option value="public">Public (All Users)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="diagramDescription" class="form-textarea" placeholder="Describe what this diagram shows and how it should be used..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Diagram Format *</label>
                    <div class="diagram-type-tabs">
                        <button type="button" class="diagram-type-tab active" id="imageTab" onclick="switchDiagramType('image')">
                            📷 Upload Image
                        </button>
                        <button type="button" class="diagram-type-tab" id="vectorTab" onclick="switchDiagramType('vector')">
                            🎨 Vector Data
                        </button>
                    </div>

                    <!-- Image Upload Section -->
                    <div id="imageSection" class="diagram-input-section active">
                        <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                            <div>📁 Click to select image</div>
                            <small>JPG, PNG, GIF (Max: 5MB)</small>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" style="display: none" onchange="previewImage(event)">
                        <img id="imagePreview" class="image-preview">
                    </div>

                    <!-- Vector Data Section -->
                    <div id="vectorSection" class="diagram-input-section">
                        <textarea id="vectorDataInput" class="form-textarea vector-data-textarea" 
                                  placeholder="Paste SVG vector data here...&#10;&#10;Example:&#10;&lt;svg width=&quot;400&quot; height=&quot;300&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;&#10;  &lt;rect x=&quot;50&quot; y=&quot;50&quot; width=&quot;300&quot; height=&quot;200&quot; fill=&quot;green&quot; stroke=&quot;brown&quot; stroke-width=&quot;4&quot;/&gt;&#10;  &lt;circle cx=&quot;200&quot; cy=&quot;150&quot; r=&quot;10&quot; fill=&quot;white&quot;/&gt;&#10;&lt;/svg&gt;"
                                  oninput="previewVector()"></textarea>
                        <div id="vectorPreview" class="vector-preview"></div>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-success" id="submitBtn">Upload</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://steveshermanbilliards.com/drill-api.php';
        
        // Global variables
        let diagrams = [];
        let filteredDiagrams = [];
        let selectedFile = null;
        let editingId = null;
        let currentUser = null;
        let currentDiagramType = 'image'; // 'image' or 'vector'
        
        // Pagination variables
        let currentPage = 1;
        let pageSize = 12;
        let totalPages = 1;
        let searchTimeout = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📊 Enhanced Diagram Admin Portal Loading with Vector Support...');
            checkAuthAndLoadUser();
        });

        // Switch between image and vector input types
        function switchDiagramType(type) {
            currentDiagramType = type;
            
            // Update tab appearances
            document.getElementById('imageTab').classList.toggle('active', type === 'image');
            document.getElementById('vectorTab').classList.toggle('active', type === 'vector');
            
            // Show/hide sections
            document.getElementById('imageSection').classList.toggle('active', type === 'image');
            document.getElementById('vectorSection').classList.toggle('active', type === 'vector');
            
            // Clear previews
            if (type === 'vector') {
                document.getElementById('imagePreview').style.display = 'none';
                selectedFile = null;
                document.getElementById('fileInput').value = '';
            } else {
                document.getElementById('vectorPreview').style.display = 'none';
                document.getElementById('vectorDataInput').value = '';
            }
        }

        // Preview vector data
        function previewVector() {
            const vectorData = document.getElementById('vectorDataInput').value.trim();
            const preview = document.getElementById('vectorPreview');
            
            if (vectorData) {
                try {
                    // Basic validation - check if it looks like SVG
                    if (vectorData.includes('<svg') && vectorData.includes('</svg>')) {
                        preview.innerHTML = vectorData;
                        preview.style.display = 'block';
                    } else {
                        preview.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">Invalid SVG format</div>';
                        preview.style.display = 'block';
                    }
                } catch (error) {
                    preview.innerHTML = '<div style="padding: 20px; color: #dc3545; text-align: center;">Error parsing SVG</div>';
                    preview.style.display = 'block';
                }
            } else {
                preview.style.display = 'none';
            }
        }

        // Open drawing tool function
        function openDrawingTool() {
            if (!currentUser) {
                alert('Authentication error. Please login again.');
                window.location.href = 'drill-admin-portal.html';
                return;
            }
            
            // Open the drawing tool in a new window/tab
            window.open('billiard-drawing-tool.html', '_blank');
        }

        // API helper with enhanced debugging
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                console.log(`🌐 API Request: ${method} ${API_BASE_URL}/${endpoint}`);
                
                const options = { method };
                
                if (data) {
                    if (data instanceof FormData) {
                        options.body = data;
                        console.log('📦 Sending FormData');
                    } else {
                        options.headers = {'Content-Type': 'application/json'};
                        options.body = JSON.stringify(data);
                        console.log('📦 Sending JSON:', data);
                    }
                }
                
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, options);
                
                console.log(`📡 Response status: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ HTTP Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('📥 Response data:', result);
                
                if (!result.success) {
                    throw new Error(result.message || 'Request failed');
                }
                
                return result;
            } catch (error) {
                console.error('❌ API Request failed:', error);
                throw error;
            }
        }

        // Check authentication and load current user
        function checkAuthAndLoadUser() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const urlUserId = urlParams.get('user_id');
                
                const savedSession = sessionStorage.getItem('adminSession');
                if (!savedSession) {
                    window.location.href = 'drill-admin-portal.html';
                    return;
                }
                
                const session = JSON.parse(savedSession);
                
                const sessionAge = Date.now() - new Date(session.loginTime).getTime();
                const maxAge = 24 * 60 * 60 * 1000;
                
                if (sessionAge >= maxAge) {
                    sessionStorage.removeItem('adminSession');
                    alert('Session expired. Please login again.');
                    window.location.href = 'drill-admin-portal.html';
                    return;
                }
                
                if (urlUserId && parseInt(urlUserId) !== session.adminId) {
                    console.warn('URL user_id does not match session user_id. Using session data.');
                }
                
                currentUser = {
                    id: session.adminId,
                    username: session.username,
                    email: session.email
                };
                
                console.log('Current user loaded:', currentUser);
                
                const userDisplay = document.getElementById('currentUserDisplay');
                if (userDisplay) {
                    userDisplay.textContent = `Logged in as: ${currentUser.username}`;
                }
                
                loadDiagrams();
                
            } catch (error) {
                console.error('Failed to load user session:', error);
                alert('Authentication error. Please login again.');
                window.location.href = 'drill-admin-portal.html';
            }
        }

        // Load diagrams with loading state and better error handling
        async function loadDiagrams() {
            try {
                console.log('🔄 Loading diagrams from API...');
                showLoadingState(true);
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const response = await apiRequest('diagrams');
                const newDiagrams = response.data || [];
                
                console.log(`✅ Loaded ${newDiagrams.length} diagrams from API`);
                
                diagrams = newDiagrams;
                filterDiagrams();
                
                return true;
                
            } catch (error) {
                console.error('❌ Failed to load diagrams:', error);
                showApiError(error);
                return false;
            } finally {
                showLoadingState(false);
            }
        }

        // Show/hide loading state
        function showLoadingState(show) {
            const loadingState = document.getElementById('loadingState');
            const diagramsContainer = document.getElementById('diagramsContainer');
            const resultsInfo = document.getElementById('resultsInfo');
            const emptyState = document.getElementById('emptyState');
            const refreshIndicator = document.getElementById('refreshIndicator');
            
            if (show) {
                loadingState.style.display = 'block';
                diagramsContainer.style.display = 'none';
                resultsInfo.style.display = 'none';
                emptyState.style.display = 'none';
                refreshIndicator.style.display = 'block';
            } else {
                loadingState.style.display = 'none';
                refreshIndicator.style.display = 'none';
            }
        }

        // Show API error with helpful information
        function showApiError(error) {
            const container = document.getElementById('diagramsContainer');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); grid-column: 1 / -1;">
                    <h3 style="color: #dc3545; margin-bottom: 15px;">⚠️ Database Connection Issue</h3>
                    <p style="color: #666; margin-bottom: 20px;">Could not load diagrams from the database.</p>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                        <strong>Possible causes:</strong><br>
                        • The wp_diagrams table doesn't exist yet<br>
                        • Diagram endpoints not added to drill-api.php<br>
                        • Database connection issue<br><br>
                        <strong>Error:</strong> ${error.message}<br>
                        <strong>API URL:</strong> ${API_BASE_URL}/diagrams
                    </div>
                    <button class="btn btn-primary" onclick="testApiConnection()">🔧 Test API Connection</button>
                    <button class="btn btn-success" onclick="loadDiagrams()">🔄 Retry</button>
                </div>
            `;
            
            showAlert('Failed to load diagrams: ' + error.message, 'error');
        }

        // Force refresh all data (for debugging)
        async function forceRefreshAll() {
            try {
                console.log('🔄 Force refreshing ALL data...');
                showLoadingState(true);
                
                diagrams = [];
                filteredDiagrams = [];
                
                await loadDiagrams();
                
            } catch (error) {
                console.error('❌ Force refresh failed:', error);
                showAlert('Force refresh failed: ' + error.message, 'error');
            } finally {
                showLoadingState(false);
            }
        }
        
        async function debugBlobStorage() {
            try {
                console.log('🔬 Running storage debug...');
                const response = await apiRequest('debug-blob');
                
                console.log('🐛 Debug results:', response.data);
                
                const debug = response.data;
                let message = `Storage Debug Results:\n\n`;
                message += `Table exists: ${debug.table_exists}\n`;
                message += `Sample records: ${debug.sample_data?.length || 0}\n`;
                message += `Directory info: ${JSON.stringify(debug.directory_info, null, 2)}\n`;
                message += `PHP settings: ${JSON.stringify(debug.php_upload_settings, null, 2)}\n`;
                message += `GD available: ${debug.gd_available}\n\n`;
                
                alert(message);
                
            } catch (error) {
                console.error('❌ Debug failed:', error);
                alert('Debug failed: ' + error.message);
            }
        }
        
        async function testApiConnection() {
            console.log('🔬 Testing API connection...');
            showLoadingState(true);
            
            try {
                const response = await apiRequest('version');
                console.log('✅ Version info:', response);
                
                showAlert('✅ API connection successful!', 'success');
                setTimeout(loadDiagrams, 1000);
                
            } catch (error) {
                console.error('❌ API test failed:', error);
                showAlert(`❌ API test failed: ${error.message}`, 'error');
            } finally {
                showLoadingState(false);
            }
        }

        // Debounced search function
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filterDiagrams();
            }, 300);
        }

        // Enhanced filter diagrams to include format filtering
        function filterDiagrams() {
            const typeFilter = document.getElementById('typeFilter').value;
            const visibilityFilter = document.getElementById('visibilityFilter').value;
            const formatFilter = document.getElementById('formatFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            filteredDiagrams = diagrams.filter(diagram => {
                const matchesType = !typeFilter || diagram.diagram_type === typeFilter;
                const matchesVisibility = !visibilityFilter || diagram.visibility === visibilityFilter;
                
                // Enhanced format filtering
                const isVector = diagram.is_vector == 1 || (diagram.vector_data && diagram.vector_data.trim() !== '');
                const matchesFormat = !formatFilter || 
                    (formatFilter === 'vector' && isVector) ||
                    (formatFilter === 'image' && !isVector);
                
                const matchesSearch = !searchTerm || 
                    diagram.name.toLowerCase().includes(searchTerm) ||
                    (diagram.description && diagram.description.toLowerCase().includes(searchTerm)) ||
                    (diagram.created_by_name && diagram.created_by_name.toLowerCase().includes(searchTerm));
                
                return matchesType && matchesVisibility && matchesFormat && matchesSearch;
            });
            
            currentPage = 1;
            renderDiagrams();
        }

        // Change page size
        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            currentPage = 1;
            renderDiagrams();
        }

        // Navigate to specific page
        function goToPage(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                currentPage = page;
                renderDiagrams();
                document.getElementById('diagramsContainer').scrollTop = 0;
            }
        }

        // Enhanced render diagrams with vector support
        function renderDiagrams() {
            const container = document.getElementById('diagramsContainer');
            const emptyState = document.getElementById('emptyState');
            const resultsInfo = document.getElementById('resultsInfo');
            
            if (filteredDiagrams.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                resultsInfo.style.display = 'none';
                return;
            }
            
            totalPages = Math.ceil(filteredDiagrams.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredDiagrams.length);
            const currentPageDiagrams = filteredDiagrams.slice(startIndex, endIndex);
            
            container.style.display = 'grid';
            emptyState.style.display = 'none';
            resultsInfo.style.display = 'flex';
            
            const resultsText = document.getElementById('resultsText');
            resultsText.textContent = `Showing ${startIndex + 1}-${endIndex} of ${filteredDiagrams.length} diagrams`;
            
            container.innerHTML = currentPageDiagrams.map(diagram => {
                const typeLabel = getTypeLabel(diagram.diagram_type);
                const visibilityIcon = diagram.visibility === 'public' ? '🌍' : '🔒';
                const visibilityLabel = diagram.visibility === 'public' ? 'Public' : 'Private';
                
                // Enhanced format detection
                const isVector = diagram.is_vector == 1 || (diagram.vector_data && diagram.vector_data.trim() !== '');
                const formatIcon = isVector ? '🎨' : '📷';
                const formatLabel = isVector ? 'Vector' : 'Image';
                const formatClass = isVector ? 'badge-vector' : 'badge-image';
                
                let imageHtml = '';
                if (isVector && diagram.vector_data) {
                    // Render vector data directly
                    imageHtml = diagram.vector_data;
                } else if (diagram.thumbnail_url) {
                    imageHtml = `<img src="${diagram.thumbnail_url}" alt="${diagram.name}" onerror="handleImageError(this)" loading="lazy">`;
                } else if (diagram.image_url) {
                    imageHtml = `<img src="${diagram.image_url}" alt="${diagram.name}" onerror="handleImageError(this)" loading="lazy">`;
                } else {
                    imageHtml = `
                        <div class="no-image">
                            <div>📊</div>
                            <small>No Preview</small>
                        </div>
                    `;
                }
                
                const description = diagram.description || 'No description';
                const descriptionId = `desc-${diagram.id}`;
                const isLongDescription = description.length > 150;
                
                let descriptionHtml = '';
                if (isLongDescription) {
                    descriptionHtml = `
                        <div class="diagram-description collapsed" id="${descriptionId}">
                            ${escapeHtml(description)}
                        </div>
                        <span class="read-more-btn" onclick="toggleDescription('${descriptionId}', this)">Read more</span>
                    `;
                } else {
                    descriptionHtml = `
                        <div class="diagram-description">
                            ${escapeHtml(description)}
                        </div>
                    `;
                }
                
                return `
                <div class="diagram-card">
                    <div class="diagram-preview">
                        ${imageHtml}
                    </div>
                    <div class="diagram-info">
                        <div class="diagram-title">${escapeHtml(diagram.name)}</div>
                        <div class="diagram-badges">
                            <span class="badge badge-type">${typeLabel}</span>
                            <span class="badge ${formatClass}">
                                ${formatIcon} ${formatLabel}
                            </span>
                            <span class="badge ${diagram.visibility === 'public' ? 'badge-public' : 'badge-private'}">
                                ${visibilityIcon} ${visibilityLabel}
                            </span>
                        </div>
                        ${descriptionHtml}
                        <div class="diagram-meta">
                            Created by: ${escapeHtml(diagram.created_by_name || 'Unknown')} • ${formatDate(diagram.created_at)}
                            ${diagram.updated_at !== diagram.created_at ? ` • Updated: ${formatDate(diagram.updated_at)}` : ''}
                        </div>
                        <div class="diagram-actions">
                            <button class="btn btn-primary btn-small" onclick="editDiagram(${diagram.id})">Edit</button>
                            <button class="btn btn-danger btn-small" onclick="deleteDiagram(${diagram.id}, '${escapeHtml(diagram.name)}')">Delete</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            updatePaginationControls();
        }

        // Toggle description expand/collapse
        function toggleDescription(descriptionId, button) {
            const descElement = document.getElementById(descriptionId);
            
            if (descElement.classList.contains('collapsed')) {
                descElement.classList.remove('collapsed');
                descElement.classList.add('expanded');
                button.textContent = 'Read less';
            } else {
                descElement.classList.remove('expanded');
                descElement.classList.add('collapsed');
                button.textContent = 'Read more';
            }
        }

        // Handle image loading errors
        function handleImageError(img) {
            const container = img.parentElement;
            container.innerHTML = `
                <div class="no-image">
                    <div>⚠️</div>
                    <small>Image Error</small>
                </div>
            `;
        }

        // Update pagination controls
        function updatePaginationControls() {
            const firstBtn = document.getElementById('firstBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const lastBtn = document.getElementById('lastBtn');
            const pageNumbers = document.getElementById('pageNumbers');
            
            firstBtn.disabled = currentPage === 1;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            lastBtn.disabled = currentPage === totalPages;
            
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            let pageNumbersHtml = '';
            for (let i = startPage; i <= endPage; i++) {
                pageNumbersHtml += `
                    <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                        ${i}
                    </button>
                `;
            }
            
            if (startPage > 1) {
                pageNumbersHtml = `<span style="padding: 0 8px;">...</span>` + pageNumbersHtml;
            }
            if (endPage < totalPages) {
                pageNumbersHtml += `<span style="padding: 0 8px;">...</span>`;
            }
            
            pageNumbers.innerHTML = pageNumbersHtml;
        }

        // Utility functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function getTypeLabel(type) {
            const typeLabels = {
                'drill': 'Drill',
                'journal': 'Journal',
                'strategy': 'Strategy',
                'technique': 'Technique',
                'table_layout': 'Table Layout',
                'equipment': 'Equipment',
                'reference': 'Reference',
                'other': 'Other'
            };
            return typeLabels[type] || type || 'Unknown';
        }

        // Open upload modal
        function openUploadModal() {
            if (!currentUser) {
                alert('Authentication error. Please login again.');
                window.location.href = 'drill-admin-portal.html';
                return;
            }
            
            editingId = null;
            currentDiagramType = 'image';
            document.getElementById('modalTitle').textContent = 'Upload Diagram';
            document.getElementById('submitBtn').textContent = 'Upload';
            document.getElementById('diagramForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('vectorPreview').style.display = 'none';
            selectedFile = null;
            
            // Reset tabs
            switchDiagramType('image');
            
            document.getElementById('uploadModal').style.display = 'block';
        }

        // Close modal
        function closeModal() {
            document.getElementById('uploadModal').style.display = 'none';
            document.getElementById('diagramForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('vectorPreview').style.display = 'none';
            selectedFile = null;
            editingId = null;
            currentDiagramType = 'image';
            document.getElementById('alertContainer').innerHTML = '';
        }

        // Preview image
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
                if (!allowedTypes.includes(file.type)) {
                    showAlert('Please select a valid image file (JPG, PNG, or GIF)', 'error');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    showAlert('File size must be less than 5MB', 'error');
                    return;
                }
                
                selectedFile = file;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // Enhanced form submission with vector support
        document.getElementById('diagramForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('diagramName').value.trim();
            const description = document.getElementById('diagramDescription').value.trim();
            const diagramType = document.getElementById('diagramType').value;
            const visibility = document.getElementById('diagramVisibility').value;
            
            if (!name || !diagramType || !visibility) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            // Validate based on diagram format
            if (currentDiagramType === 'image') {
                if (!editingId && !selectedFile) {
                    showAlert('Please select an image file', 'error');
                    return;
                }
            } else if (currentDiagramType === 'vector') {
                const vectorData = document.getElementById('vectorDataInput').value.trim();
                if (!vectorData) {
                    showAlert('Please enter vector data', 'error');
                    return;
                }
                if (!vectorData.includes('<svg') || !vectorData.includes('</svg>')) {
                    showAlert('Please enter valid SVG vector data', 'error');
                    return;
                }
            }
            
            if (!currentUser || !currentUser.id) {
                showAlert('Authentication error. Please login again.', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = editingId ? 'Updating...' : 'Uploading...';
                
                const formData = new FormData();
                formData.append('name', name);
                formData.append('description', description);
                formData.append('diagram_type', diagramType);
                formData.append('visibility', visibility);
                formData.append('created_by', currentUser.id);
                
                // Add format-specific data
                if (currentDiagramType === 'vector') {
                    const vectorData = document.getElementById('vectorDataInput').value.trim();
                    formData.append('vector_data', vectorData);
                    formData.append('is_vector', '1');
                } else {
                    formData.append('is_vector', '0');
                    if (selectedFile) {
                        formData.append('image', selectedFile);
                    }
                }
                
                let response;
                if (editingId) {
                    response = await apiRequest(`diagrams/${editingId}`, 'PUT', formData);
                    showAlert('Diagram updated successfully', 'success');
                } else {
                    response = await apiRequest('diagrams', 'POST', formData);
                    showAlert('Diagram uploaded successfully', 'success');
                }
                
                closeModal();
                await performEnhancedRefresh();
                
            } catch (error) {
                console.error('❌ Form submission failed:', error);
                showAlert('Failed to save diagram: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Enhanced refresh process
        async function performEnhancedRefresh() {
            try {
                const refreshIndicator = document.getElementById('refreshIndicator');
                if (refreshIndicator) {
                    refreshIndicator.style.display = 'block';
                }
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                diagrams = [];
                filteredDiagrams = [];
                
                const response = await apiRequest('diagrams');
                const newDiagrams = response.data || [];
                
                diagrams = newDiagrams;
                filterDiagrams();
                
                if (refreshIndicator) {
                    refreshIndicator.style.display = 'none';
                }
                
                return true;
                
            } catch (error) {
                console.error('❌ Enhanced refresh failed:', error);
                const refreshIndicator = document.getElementById('refreshIndicator');
                if (refreshIndicator) {
                    refreshIndicator.style.display = 'none';
                }
                throw error;
            }
        }

        // Enhanced edit diagram with vector support
        async function editDiagram(id) {
            try {
                const response = await apiRequest(`diagrams/${id}`);
                const diagram = response.data;
                
                editingId = id;
                document.getElementById('modalTitle').textContent = 'Edit Diagram';
                document.getElementById('submitBtn').textContent = 'Update';
                
                document.getElementById('diagramName').value = diagram.name;
                document.getElementById('diagramDescription').value = diagram.description || '';
                document.getElementById('diagramType').value = diagram.diagram_type || 'drill';
                document.getElementById('diagramVisibility').value = diagram.visibility || 'private';
                
                // Determine if this is a vector or image diagram
                const isVector = diagram.is_vector == 1 || (diagram.vector_data && diagram.vector_data.trim() !== '');
                
                if (isVector) {
                    switchDiagramType('vector');
                    document.getElementById('vectorDataInput').value = diagram.vector_data || '';
                    previewVector();
                } else {
                    switchDiagramType('image');
                    selectedFile = null;
                    document.getElementById('fileInput').value = '';
                    
                    if (diagram.image_url) {
                        const preview = document.getElementById('imagePreview');
                        preview.src = diagram.image_url;
                        preview.style.display = 'block';
                    } else {
                        document.getElementById('imagePreview').style.display = 'none';
                    }
                }
                
                document.getElementById('uploadModal').style.display = 'block';
                
            } catch (error) {
                console.error('❌ Failed to load diagram for editing:', error);
                showAlert('Failed to load diagram: ' + error.message, 'error');
            }
        }

        // Delete diagram
        async function deleteDiagram(id, name) {
            if (!confirm(`Are you sure you want to delete the diagram "${name}"?`)) {
                return;
            }
            
            try {
                await apiRequest(`diagrams/${id}`, 'DELETE');
                showAlert('Diagram deleted successfully', 'success');
                await performEnhancedRefresh();
                
            } catch (error) {
                console.error('❌ Delete failed:', error);
                showAlert('Failed to delete diagram: ' + error.message, 'error');
            }
        }

        // Show alert
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            
            container.innerHTML = `<div class="alert ${alertClass}" style="display: block;">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
            
            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('uploadModal').style.display === 'block') {
                closeModal();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
        });

        console.log('📊 Enhanced Diagram Admin Portal Ready - Version 3.0');
        console.log('🎯 Features: Vector diagram support, enhanced filtering, improved UI');
    </script>
</body>
</html>