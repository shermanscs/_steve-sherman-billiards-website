<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagram Admin - Steve Sherman Billiards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .content {
            padding: 40px;
        }

        .admin-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
        }

        .user-info {
            text-align: right;
            color: #666;
            font-size: 0.9em;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #667eea;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Pagination and Results Info */
        .results-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            color: #666;
            font-size: 0.9em;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .page-size-selector select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Diagrams Grid with Scrolling */
        .diagrams-container {
            position: relative;
        }

        .diagrams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            max-height: 800px;
            overflow-y: auto;
            padding-right: 10px;
            margin-right: -10px;
        }

        /* Custom scrollbar */
        .diagrams-grid::-webkit-scrollbar {
            width: 8px;
        }

        .diagrams-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .diagrams-grid::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .diagrams-grid::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }

        .diagram-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .diagram-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .diagram-preview {
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            position: relative;
            overflow: hidden;
        }

        .diagram-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .diagram-preview .no-image {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 2em;
        }

        .diagram-preview .no-image small {
            font-size: 0.4em;
            color: #999;
        }

        .diagram-info {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .diagram-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .diagram-badges {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-type {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-public {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .badge-private {
            background: #fff3cd;
            color: #856404;
        }

        .diagram-description {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.9em;
            flex-grow: 1;
            line-height: 1.4;
            position: relative;
        }

        .diagram-description.collapsed {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .diagram-description.expanded {
            display: block;
        }

        .read-more-btn {
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            margin-top: 5px;
            text-decoration: underline;
            display: inline-block;
        }

        .read-more-btn:hover {
            color: #5a6fd8;
        }

        .diagram-meta {
            font-size: 0.8em;
            color: #999;
            margin-bottom: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .diagram-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: auto;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .file-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 15px;
            border-radius: 8px;
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ddd;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1001;
            display: none;
            animation: pulse 1.5s infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .content {
                padding: 20px;
            }

            .admin-nav {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .results-info {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            .pagination-controls {
                justify-content: center;
            }

            .diagrams-grid {
                grid-template-columns: 1fr;
                max-height: 600px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Diagram Management</h1>
            <p>Upload and manage diagrams</p>
        </div>

        <div class="content">
            <div class="admin-nav">
                <div class="nav-buttons">
                    <a href="drill-admin-portal.html" class="btn btn-secondary">‚Üê Back to Admin Portal</a>
                    <button class="btn btn-primary" onclick="loadDiagrams()">üîÑ Refresh Data</button>
                    <button class="btn btn-secondary" onclick="debugBlobStorage()">üîß Debug BLOB Storage</button>
                    <button class="btn btn-secondary" onclick="forceRefreshAll()">üöÄ Force Refresh All</button>
                </div>
                <div class="user-info">
                    <span id="currentUserDisplay"></span>
                    <br><small>Diagram Admin | Version 2.8 - Added Billiard Drawing Tool</small>
                </div>
            </div>

            <div class="controls">
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="openUploadModal()">
                        üìÅ Upload Diagram
                    </button>
                    <button class="btn btn-primary" onclick="openDrawingTool()">
                        üé± Create Billiard Diagram
                    </button>
                    <select id="typeFilter" class="form-input" style="min-width: 150px;" onchange="filterDiagrams()">
                        <option value="">All Types</option>
                        <option value="drill">Drill Diagrams</option>
                        <option value="journal">Journal</option>
                        <option value="strategy">Strategy</option>
                        <option value="technique">Technique</option>
                        <option value="table_layout">Table Layout</option>
                        <option value="equipment">Equipment</option>
                        <option value="reference">Reference</option>
                        <option value="other">Other</option>
                    </select>
                    <select id="visibilityFilter" class="form-input" style="min-width: 120px;" onchange="filterDiagrams()">
                        <option value="">All Visibility</option>
                        <option value="public">Public</option>
                        <option value="private">Private</option>
                    </select>
                    <input type="text" id="searchInput" class="form-input" placeholder="Search diagrams..." style="min-width: 200px;" onkeyup="debounceSearch()">
                </div>
            </div>

            <div id="alertContainer"></div>

            <!-- Results Info and Pagination -->
            <div id="resultsInfo" class="results-info" style="display: none;">
                <div class="pagination-info">
                    <span id="resultsText">Showing 0 of 0 diagrams</span>
                </div>
                <div class="pagination-controls">
                    <div class="page-size-selector">
                        <label>Show:</label>
                        <select id="pageSizeSelect" onchange="changePageSize()">
                            <option value="12">12 per page</option>
                            <option value="24">24 per page</option>
                            <option value="48">48 per page</option>
                            <option value="96">96 per page</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <button class="pagination-btn" id="firstBtn" onclick="goToPage(1)">¬´¬´</button>
                        <button class="pagination-btn" id="prevBtn" onclick="goToPage(currentPage - 1)">‚Äπ</button>
                        <span id="pageNumbers"></span>
                        <button class="pagination-btn" id="nextBtn" onclick="goToPage(currentPage + 1)">‚Ä∫</button>
                        <button class="pagination-btn" id="lastBtn" onclick="goToPage(totalPages)">¬ª¬ª</button>
                    </div>
                </div>
            </div>

            <div class="diagrams-container">
                <div id="diagramsContainer" class="diagrams-grid"></div>
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <h3>No Diagrams Found</h3>
                <p>Upload your first diagram to get started</p>
            </div>

            <div id="loadingState" class="loading" style="display: none;">
                Loading diagrams...
            </div>
            
            <!-- Refresh Indicator -->
            <div id="refreshIndicator" class="refresh-indicator">
                üîÑ Updating data...
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Upload Diagram</h2>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>

            <form id="diagramForm">
                <input type="hidden" id="diagramId">

                <div class="form-group">
                    <label class="form-label">Diagram Name *</label>
                    <input type="text" id="diagramName" class="form-input" required>
                </div>

                <div style="display: flex; gap: 15px;">
                    <div style="flex: 1;">
                        <label class="form-label">Diagram Type *</label>
                        <select id="diagramType" class="form-input" required>
                            <option value="">Select type...</option>
                            <option value="drill">Drill Diagram</option>
                            <option value="journal">Journal Illustration</option>
                            <option value="strategy">Strategy Board</option>
                            <option value="technique">Technique Guide</option>
                            <option value="table_layout">Table Layout</option>
                            <option value="equipment">Equipment Guide</option>
                            <option value="reference">Reference Material</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label class="form-label">Visibility *</label>
                        <select id="diagramVisibility" class="form-input" required>
                            <option value="private">Private (Only You)</option>
                            <option value="public">Public (All Users)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="diagramDescription" class="form-textarea" placeholder="Describe what this diagram shows and how it should be used..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Image File *</label>
                    <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                        <div>üìÅ Click to select image</div>
                        <small>JPG, PNG, GIF (Max: 5MB)</small>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" style="display: none" onchange="previewImage(event)">
                    <img id="imagePreview" class="image-preview">
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-success" id="submitBtn">Upload</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://steveshermanbilliards.com/drill-api.php';
        
        // Global variables
        let diagrams = [];
        let filteredDiagrams = [];
        let selectedFile = null;
        let editingId = null;
        let currentUser = null;
        
        // Pagination variables
        let currentPage = 1;
        let pageSize = 12;
        let totalPages = 1;
        let searchTimeout = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìä Enhanced Diagram Admin Portal Loading...');
            checkAuthAndLoadUser();
        });

        // Open drawing tool function
        function openDrawingTool() {
            if (!currentUser) {
                alert('Authentication error. Please login again.');
                window.location.href = 'drill-admin-portal.html';
                return;
            }
            
            // Open the drawing tool in a new window/tab
            window.open('billiard-drawing-tool.html', '_blank');
        }

        // API helper with enhanced debugging
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                console.log(`üåê API Request: ${method} ${API_BASE_URL}/${endpoint}`);
                
                const options = { method };
                
                if (data) {
                    if (data instanceof FormData) {
                        options.body = data;
                        console.log('üì¶ Sending FormData');
                        // Don't set Content-Type header for FormData - browser will set it with boundary
                    } else {
                        options.headers = {'Content-Type': 'application/json'};
                        options.body = JSON.stringify(data);
                        console.log('üì¶ Sending JSON:', data);
                    }
                }
                
                console.log('‚öôÔ∏è Fetch options:', {
                    method: options.method,
                    hasBody: !!options.body,
                    bodyType: options.body instanceof FormData ? 'FormData' : typeof options.body,
                    headers: options.headers || 'default'
                });
                
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, options);
                
                console.log(`üì° Response status: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå HTTP Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('üì• Response data:', result);
                
                if (!result.success) {
                    throw new Error(result.message || 'Request failed');
                }
                
                return result;
            } catch (error) {
                console.error('‚ùå API Request failed:', error);
                throw error;
            }
        }

        // Check authentication and load current user
        function checkAuthAndLoadUser() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const urlUserId = urlParams.get('user_id');
                
                const savedSession = sessionStorage.getItem('adminSession');
                if (!savedSession) {
                    window.location.href = 'drill-admin-portal.html';
                    return;
                }
                
                const session = JSON.parse(savedSession);
                
                const sessionAge = Date.now() - new Date(session.loginTime).getTime();
                const maxAge = 24 * 60 * 60 * 1000;
                
                if (sessionAge >= maxAge) {
                    sessionStorage.removeItem('adminSession');
                    alert('Session expired. Please login again.');
                    window.location.href = 'drill-admin-portal.html';
                    return;
                }
                
                if (urlUserId && parseInt(urlUserId) !== session.adminId) {
                    console.warn('URL user_id does not match session user_id. Using session data.');
                }
                
                currentUser = {
                    id: session.adminId,
                    username: session.username,
                    email: session.email
                };
                
                console.log('Current user loaded:', currentUser);
                
                const userDisplay = document.getElementById('currentUserDisplay');
                if (userDisplay) {
                    userDisplay.textContent = `Logged in as: ${currentUser.username}`;
                }
                
                loadDiagrams();
                
            } catch (error) {
                console.error('Failed to load user session:', error);
                alert('Authentication error. Please login again.');
                window.location.href = 'drill-admin-portal.html';
            }
        }

        // Load diagrams with loading state and better error handling
        async function loadDiagrams() {
            try {
                console.log('üîÑ Loading diagrams from API...');
                showLoadingState(true);
                
                // Add a small delay to ensure database operations are complete
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const response = await apiRequest('diagrams');
                const newDiagrams = response.data || [];
                
                console.log(`‚úÖ Loaded ${newDiagrams.length} diagrams from API`);
                console.log('üìã Diagram IDs:', newDiagrams.map(d => `${d.id}(${d.name})`).join(', '));
                
                // Check if any diagrams have is_active = 0 (they shouldn't from API)
                const inactiveDiagrams = newDiagrams.filter(d => d.is_active === 0 || d.is_active === '0');
                if (inactiveDiagrams.length > 0) {
                    console.warn('‚ö†Ô∏è Found inactive diagrams in API response:', inactiveDiagrams.map(d => `ID:${d.id}`));
                }
                
                // Update global state
                diagrams = newDiagrams;
                
                // Apply current filters and render
                filterDiagrams();
                
                console.log(`üéØ Load complete - Total: ${diagrams.length}, Filtered: ${filteredDiagrams.length}, Current page: ${currentPage}`);
                
                return true; // Indicate successful completion
                
            } catch (error) {
                console.error('‚ùå Failed to load diagrams:', error);
                showApiError(error);
                return false; // Indicate failure
            } finally {
                showLoadingState(false);
            }
        }

        // Show/hide loading state
        function showLoadingState(show) {
            const loadingState = document.getElementById('loadingState');
            const diagramsContainer = document.getElementById('diagramsContainer');
            const resultsInfo = document.getElementById('resultsInfo');
            const emptyState = document.getElementById('emptyState');
            const refreshIndicator = document.getElementById('refreshIndicator');
            
            if (show) {
                loadingState.style.display = 'block';
                diagramsContainer.style.display = 'none';
                resultsInfo.style.display = 'none';
                emptyState.style.display = 'none';
                refreshIndicator.style.display = 'block';
            } else {
                loadingState.style.display = 'none';
                refreshIndicator.style.display = 'none';
            }
        }

        // Show API error with helpful information
        function showApiError(error) {
            const container = document.getElementById('diagramsContainer');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); grid-column: 1 / -1;">
                    <h3 style="color: #dc3545; margin-bottom: 15px;">‚ö†Ô∏è Database Connection Issue</h3>
                    <p style="color: #666; margin-bottom: 20px;">Could not load diagrams from the database.</p>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                        <strong>Possible causes:</strong><br>
                        ‚Ä¢ The wp_diagrams table doesn't exist yet<br>
                        ‚Ä¢ Diagram endpoints not added to drill-api.php<br>
                        ‚Ä¢ Database connection issue<br><br>
                        <strong>Error:</strong> ${error.message}<br>
                        <strong>API URL:</strong> ${API_BASE_URL}/diagrams
                    </div>
                    <button class="btn btn-primary" onclick="testApiConnection()">üîß Test API Connection</button>
                    <button class="btn btn-success" onclick="loadDiagrams()">üîÑ Retry</button>
                </div>
            `;
            
            showAlert('Failed to load diagrams: ' + error.message, 'error');
        }

        // Force refresh all data (for debugging)
        async function forceRefreshAll() {
            try {
                console.log('üîÑ Force refreshing ALL data...');
                showLoadingState(true);
                
                // Clear local data
                diagrams = [];
                filteredDiagrams = [];
                
                // Load fresh data
                await loadDiagrams();
                
                console.log(`üéØ After force refresh - diagrams: ${diagrams.length}, filtered: ${filteredDiagrams.length}`);
                
            } catch (error) {
                console.error('‚ùå Force refresh failed:', error);
                showAlert('Force refresh failed: ' + error.message, 'error');
            } finally {
                showLoadingState(false);
            }
        }
        
        async function debugBlobStorage() {
            try {
                console.log('üî¨ Running BLOB storage debug...');
                const response = await apiRequest('debug-blob');
                
                console.log('üêõ Debug results:', response.data);
                
                const debug = response.data;
                let message = `BLOB Storage Debug Results:\n\n`;
                message += `Table exists: ${debug.table_exists}\n`;
                message += `Sample records: ${debug.sample_data.length}\n`;
                message += `MySQL max packet: ${debug.mysql_max_packet?.Value || 'Unknown'}\n`;
                message += `PHP upload max: ${debug.php_upload_max}\n`;
                message += `PHP post max: ${debug.php_post_max}\n\n`;
                
                if (debug.sample_data.length > 0) {
                    message += `Sample data:\n`;
                    debug.sample_data.forEach(item => {
                        message += `- ID ${item.id}: "${item.name}" | Size: ${item.blob_size} bytes | Type: ${item.image_type}\n`;
                    });
                } else {
                    message += `No sample data found.\n`;
                }
                
                message += `\nColumn info:\n`;
                debug.column_info.forEach(col => {
                    if (col.Field === 'image_data') {
                        message += `- image_data: ${col.Type} (${col.Null === 'YES' ? 'nullable' : 'not null'})\n`;
                    }
                });
                
                alert(message);
                
                // Also show in console for detailed inspection
                console.table(debug.sample_data);
                console.table(debug.column_info);
                
            } catch (error) {
                console.error('‚ùå Debug failed:', error);
                alert('Debug failed: ' + error.message);
            }
        }
        
        async function testApiConnection() {
            console.log('üî¨ Testing API connection...');
            showLoadingState(true);
            
            try {
                console.log('Testing version endpoint...');
                const versionResponse = await apiRequest('version');
                console.log('‚úÖ Version info:', versionResponse);
                
                console.log('Testing diagrams endpoint directly...');
                const directResponse = await fetch(`${API_BASE_URL}/diagrams`);
                console.log('üì° Direct diagrams response status:', directResponse.status);
                
                const responseText = await directResponse.text();
                console.log('üìÑ Direct diagrams response text:', responseText);
                
                if (directResponse.ok) {
                    try {
                        const jsonResponse = JSON.parse(responseText);
                        console.log('‚úÖ Diagrams endpoint works:', jsonResponse);
                        showAlert('‚úÖ API connection successful! All endpoints working.', 'success');
                        // Retry loading diagrams
                        setTimeout(loadDiagrams, 1000);
                    } catch (parseError) {
                        console.error('‚ùå JSON parse error:', parseError);
                        showAlert(`‚ùå API returned invalid JSON: ${responseText}`, 'error');
                    }
                } else {
                    console.error('‚ùå HTTP error:', directResponse.status);
                    showAlert(`‚ùå API HTTP error ${directResponse.status}: ${responseText}`, 'error');
                }
                
            } catch (error) {
                console.error('‚ùå API test failed:', error);
                
                let errorDetails = '';
                if (error.message.includes('404')) {
                    errorDetails = 'The diagrams endpoint is not found. You need to add the diagram endpoints to your drill-api.php file.';
                } else if (error.message.includes('500')) {
                    errorDetails = 'Server error - likely a PHP error in the diagram methods. Check your server error logs.';
                } else {
                    errorDetails = 'Network or API connection issue.';
                }
                
                showAlert(`‚ùå API test failed: ${errorDetails}`, 'error');
                window.open(`${API_BASE_URL}/diagrams`, '_blank');
            } finally {
                showLoadingState(false);
            }
        }

        // Debounced search function
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filterDiagrams();
            }, 300);
        }

        // Filter diagrams by type, visibility, and search
        function filterDiagrams() {
            const typeFilter = document.getElementById('typeFilter').value;
            const visibilityFilter = document.getElementById('visibilityFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            console.log(`üîç Filtering ${diagrams.length} diagrams - Type: "${typeFilter}", Visibility: "${visibilityFilter}", Search: "${searchTerm}"`);
            
            filteredDiagrams = diagrams.filter(diagram => {
                const matchesType = !typeFilter || diagram.diagram_type === typeFilter;
                const matchesVisibility = !visibilityFilter || diagram.visibility === visibilityFilter;
                const matchesSearch = !searchTerm || 
                    diagram.name.toLowerCase().includes(searchTerm) ||
                    (diagram.description && diagram.description.toLowerCase().includes(searchTerm)) ||
                    (diagram.created_by_name && diagram.created_by_name.toLowerCase().includes(searchTerm));
                
                return matchesType && matchesVisibility && matchesSearch;
            });
            
            console.log(`‚úÖ Filter complete - ${filteredDiagrams.length} diagrams match filters`);
            
            // Reset to first page when filtering
            currentPage = 1;
            renderDiagrams();
        }

        // Change page size
        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            currentPage = 1; // Reset to first page
            renderDiagrams();
        }

        // Navigate to specific page
        function goToPage(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                currentPage = page;
                renderDiagrams();
                
                // Scroll to top of grid
                document.getElementById('diagramsContainer').scrollTop = 0;
            }
        }

        // Render diagrams with pagination
        function renderDiagrams() {
            const container = document.getElementById('diagramsContainer');
            const emptyState = document.getElementById('emptyState');
            const resultsInfo = document.getElementById('resultsInfo');
            
            if (filteredDiagrams.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                resultsInfo.style.display = 'none';
                return;
            }
            
            // Calculate pagination
            totalPages = Math.ceil(filteredDiagrams.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredDiagrams.length);
            const currentPageDiagrams = filteredDiagrams.slice(startIndex, endIndex);
            
            // Show container and results info
            container.style.display = 'grid';
            emptyState.style.display = 'none';
            resultsInfo.style.display = 'flex';
            
            // Update results text
            const resultsText = document.getElementById('resultsText');
            resultsText.textContent = `Showing ${startIndex + 1}-${endIndex} of ${filteredDiagrams.length} diagrams`;
            
            // Render current page diagrams
            container.innerHTML = currentPageDiagrams.map(diagram => {
                const typeLabel = getTypeLabel(diagram.diagram_type);
                const visibilityIcon = diagram.visibility === 'public' ? 'üåç' : 'üîí';
                const visibilityLabel = diagram.visibility === 'public' ? 'Public' : 'Private';
                
                // Handle image display - using file system URLs
                let imageHtml = '';
                if (diagram.thumbnail_url) {
                    imageHtml = `<img src="${diagram.thumbnail_url}" alt="${diagram.name}" onerror="handleImageError(this)" loading="lazy">`;
                } else if (diagram.image_url) {
                    imageHtml = `<img src="${diagram.image_url}" alt="${diagram.name}" onerror="handleImageError(this)" loading="lazy" style="object-fit: cover;">`;
                } else {
                    imageHtml = `
                        <div class="no-image">
                            <div>üìä</div>
                            <small>No Image</small>
                        </div>
                    `;
                }
                
                // Handle description with read more functionality
                const description = diagram.description || 'No description';
                const descriptionId = `desc-${diagram.id}`;
                const isLongDescription = description.length > 150; // Roughly 3 lines
                
                let descriptionHtml = '';
                if (isLongDescription) {
                    descriptionHtml = `
                        <div class="diagram-description collapsed" id="${descriptionId}">
                            ${escapeHtml(description)}
                        </div>
                        <span class="read-more-btn" onclick="toggleDescription('${descriptionId}', this)">Read more</span>
                    `;
                } else {
                    descriptionHtml = `
                        <div class="diagram-description">
                            ${escapeHtml(description)}
                        </div>
                    `;
                }
                
                return `
                <div class="diagram-card">
                    <div class="diagram-preview">
                        ${imageHtml}
                    </div>
                    <div class="diagram-info">
                        <div class="diagram-title">${escapeHtml(diagram.name)}</div>
                        <div class="diagram-badges">
                            <span class="badge badge-type">${typeLabel}</span>
                            <span class="badge ${diagram.visibility === 'public' ? 'badge-public' : 'badge-private'}">
                                ${visibilityIcon} ${visibilityLabel}
                            </span>
                        </div>
                        ${descriptionHtml}
                        <div class="diagram-meta">
                            Created by: ${escapeHtml(diagram.created_by_name || 'Unknown')} ‚Ä¢ ${formatDate(diagram.created_at)}
                            ${diagram.updated_at !== diagram.created_at ? ` ‚Ä¢ Updated: ${formatDate(diagram.updated_at)}` : ''}
                        </div>
                        <div class="diagram-actions">
                            <button class="btn btn-primary btn-small" onclick="editDiagram(${diagram.id})">Edit</button>
                            <button class="btn btn-danger btn-small" onclick="deleteDiagram(${diagram.id}, '${escapeHtml(diagram.name)}')">Delete</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            // Update pagination controls
            updatePaginationControls();
        }

        // Toggle description expand/collapse
        function toggleDescription(descriptionId, button) {
            const descElement = document.getElementById(descriptionId);
            
            if (descElement.classList.contains('collapsed')) {
                descElement.classList.remove('collapsed');
                descElement.classList.add('expanded');
                button.textContent = 'Read less';
            } else {
                descElement.classList.remove('expanded');
                descElement.classList.add('collapsed');
                button.textContent = 'Read more';
            }
        }

        // Handle image loading errors
        function handleImageError(img) {
            const container = img.parentElement;
            container.innerHTML = `
                <div class="no-image">
                    <div>‚ö†Ô∏è</div>
                    <small>Image Error</small>
                </div>
            `;
        }

        // Update pagination controls
        function updatePaginationControls() {
            const firstBtn = document.getElementById('firstBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const lastBtn = document.getElementById('lastBtn');
            const pageNumbers = document.getElementById('pageNumbers');
            
            // Update button states
            firstBtn.disabled = currentPage === 1;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            lastBtn.disabled = currentPage === totalPages;
            
            // Generate page numbers (show max 5 pages around current)
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            // Adjust start if we're near the end
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            let pageNumbersHtml = '';
            for (let i = startPage; i <= endPage; i++) {
                pageNumbersHtml += `
                    <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                        ${i}
                    </button>
                `;
            }
            
            // Add ellipsis if needed
            if (startPage > 1) {
                pageNumbersHtml = `<span style="padding: 0 8px;">...</span>` + pageNumbersHtml;
            }
            if (endPage < totalPages) {
                pageNumbersHtml += `<span style="padding: 0 8px;">...</span>`;
            }
            
            pageNumbers.innerHTML = pageNumbersHtml;
        }

        // Utility functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Get human-readable type label
        function getTypeLabel(type) {
            const typeLabels = {
                'drill': 'Drill',
                'journal': 'Journal',
                'strategy': 'Strategy',
                'technique': 'Technique',
                'table_layout': 'Table Layout',
                'equipment': 'Equipment',
                'reference': 'Reference',
                'other': 'Other'
            };
            return typeLabels[type] || type || 'Unknown';
        }

        // Open upload modal
        function openUploadModal() {
            if (!currentUser) {
                alert('Authentication error. Please login again.');
                window.location.href = 'drill-admin-portal.html';
                return;
            }
            
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Upload Diagram';
            document.getElementById('submitBtn').textContent = 'Upload';
            document.getElementById('diagramForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            selectedFile = null;
            document.getElementById('uploadModal').style.display = 'block';
        }

        // Close modal and reset state
        function closeModal() {
            console.log('üö™ Closing modal');
            document.getElementById('uploadModal').style.display = 'none';
            
            // Reset form and state
            document.getElementById('diagramForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            selectedFile = null;
            editingId = null;
            
            // Clear any alerts in the modal area
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = '';
            
            console.log('‚úÖ Modal closed and reset');
        }

        // Preview image
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
                if (!allowedTypes.includes(file.type)) {
                    showAlert('Please select a valid image file (JPG, PNG, or GIF)', 'error');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    showAlert('File size must be less than 5MB', 'error');
                    return;
                }
                
                selectedFile = file;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // Handle form submission with enhanced debugging and improved refresh
        document.getElementById('diagramForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('üìù Form submission started');
            
            const name = document.getElementById('diagramName').value.trim();
            const description = document.getElementById('diagramDescription').value.trim();
            const diagramType = document.getElementById('diagramType').value;
            const visibility = document.getElementById('diagramVisibility').value;
            
            console.log('üìã Form data:', { name, description, diagramType, visibility, editingId, hasSelectedFile: !!selectedFile });
            
            if (!name) {
                showAlert('Name is required', 'error');
                return;
            }
            
            if (!diagramType) {
                showAlert('Please select a diagram type', 'error');
                return;
            }
            
            if (!visibility) {
                showAlert('Please select visibility setting', 'error');
                return;
            }
            
            if (!editingId && !selectedFile) {
                showAlert('Please select an image file', 'error');
                return;
            }
            
            if (!currentUser || !currentUser.id) {
                showAlert('Authentication error. Please login again.', 'error');
                window.location.href = 'drill-admin-portal.html';
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = editingId ? 'Updating...' : 'Uploading...';
                
                const formData = new FormData();
                formData.append('name', name);
                formData.append('description', description);
                formData.append('diagram_type', diagramType);
                formData.append('visibility', visibility);
                formData.append('created_by', currentUser.id);
                
                if (selectedFile) {
                    formData.append('image', selectedFile);
                    console.log('üì∏ Including image file:', selectedFile.name, selectedFile.size, 'bytes');
                }
                
                // Log FormData contents (for debugging)
                console.log('üì§ FormData contents:');
                for (let [key, value] of formData.entries()) {
                    if (key === 'image') {
                        console.log(`  ${key}: File(${value.name}, ${value.size} bytes)`);
                    } else {
                        console.log(`  ${key}: ${value}`);
                    }
                }
                
                let response;
                if (editingId) {
                    console.log(`üìù Sending UPDATE request for diagram ID: ${editingId}`);
                    console.log(`üîó URL: ${API_BASE_URL}/diagrams/${editingId}`);
                    
                    response = await apiRequest(`diagrams/${editingId}`, 'PUT', formData);
                    console.log('‚úÖ UPDATE response:', response);
                    
                    showAlert('Diagram updated successfully', 'success');
                } else {
                    console.log('üì§ Sending CREATE request for new diagram');
                    console.log(`üîó URL: ${API_BASE_URL}/diagrams`);
                    
                    response = await apiRequest('diagrams', 'POST', formData);
                    console.log('‚úÖ CREATE response:', response);
                    
                    showAlert('Diagram uploaded successfully', 'success');
                }
                
                console.log('üö™ Closing modal...');
                closeModal();
                
                // Enhanced refresh process
                console.log('üîÑ Starting enhanced refresh process...');
                await performEnhancedRefresh();
                
                console.log('üéØ Form submission complete - UI should be updated');
                
            } catch (error) {
                console.error('‚ùå Form submission failed:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                showAlert('Failed to save diagram: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                console.log('üîì Form submission finally block - button re-enabled');
            }
        });

        // Enhanced refresh process to ensure UI updates
        async function performEnhancedRefresh() {
            try {
                console.log('üîÑ Enhanced refresh starting...');
                
                // Show refresh indicator
                const refreshIndicator = document.getElementById('refreshIndicator');
                if (refreshIndicator) {
                    refreshIndicator.style.display = 'block';
                }
                
                // Add a longer delay to ensure database transaction is complete
                console.log('‚è±Ô∏è Waiting for database transaction to complete...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Clear current data
                console.log('üóëÔ∏è Clearing current data...');
                diagrams = [];
                filteredDiagrams = [];
                
                // Force reload from API
                console.log('üì° Reloading from API...');
                const response = await apiRequest('diagrams');
                const newDiagrams = response.data || [];
                
                console.log(`‚úÖ Received ${newDiagrams.length} diagrams from API`);
                
                // Update global state
                diagrams = newDiagrams;
                
                // Reapply filters
                console.log('üîç Reapplying filters...');
                filterDiagrams();
                
                // Hide refresh indicator
                if (refreshIndicator) {
                    refreshIndicator.style.display = 'none';
                }
                
                console.log(`üéØ Enhanced refresh complete - Total: ${diagrams.length}, Filtered: ${filteredDiagrams.length}`);
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Enhanced refresh failed:', error);
                const refreshIndicator = document.getElementById('refreshIndicator');
                if (refreshIndicator) {
                    refreshIndicator.style.display = 'none';
                }
                throw error;
            }
        }

        // Edit diagram with improved state management
        async function editDiagram(id) {
            try {
                console.log(`üìù Loading diagram ${id} for editing`);
                
                const response = await apiRequest(`diagrams/${id}`);
                const diagram = response.data;
                
                console.log('üìÑ Loaded diagram for editing:', diagram);
                
                editingId = id;
                document.getElementById('modalTitle').textContent = 'Edit Diagram';
                document.getElementById('submitBtn').textContent = 'Update';
                
                document.getElementById('diagramName').value = diagram.name;
                document.getElementById('diagramDescription').value = diagram.description || '';
                document.getElementById('diagramType').value = diagram.diagram_type || 'drill';
                document.getElementById('diagramVisibility').value = diagram.visibility || 'private';
                
                // Reset file selection since we're editing
                selectedFile = null;
                document.getElementById('fileInput').value = '';
                
                if (diagram.image_data && diagram.image_type) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = `data:${diagram.image_type};base64,${diagram.image_data}`;
                    preview.style.display = 'block';
                } else {
                    document.getElementById('imagePreview').style.display = 'none';
                }
                
                document.getElementById('uploadModal').style.display = 'block';
                
                console.log('‚úÖ Edit modal opened');
                
            } catch (error) {
                console.error('‚ùå Failed to load diagram for editing:', error);
                showAlert('Failed to load diagram: ' + error.message, 'error');
            }
        }

        // Delete diagram with confirmation and enhanced refresh
        async function deleteDiagram(id, name) {
            if (!confirm(`Are you sure you want to delete the diagram "${name}"?\n\nThis action will hide the diagram but preserve it in the database.`)) {
                return;
            }
            
            try {
                console.log(`üóëÔ∏è Deleting diagram ID: ${id}`);
                await apiRequest(`diagrams/${id}`, 'DELETE');
                showAlert('Diagram deleted successfully', 'success');
                
                // Use enhanced refresh for deletes too
                console.log('üîÑ Starting enhanced refresh after delete...');
                await performEnhancedRefresh();
                
                console.log(`üìä After delete - Total diagrams: ${diagrams.length}, Filtered: ${filteredDiagrams.length}`);
                
            } catch (error) {
                console.error('‚ùå Delete failed:', error);
                showAlert('Failed to delete diagram: ' + error.message, 'error');
            }
        }

        // Show alert with auto-dismiss
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            
            container.innerHTML = `<div class="alert ${alertClass}" style="display: block;">${message}</div>`;
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
            
            // Scroll to top to show alert
            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // ESC to close modal
            if (e.key === 'Escape' && document.getElementById('uploadModal').style.display === 'block') {
                closeModal();
            }
            
            // Ctrl/Cmd + K to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
        });

        console.log('üìä Enhanced Diagram Admin Portal Ready - Version 2.8 - Added Billiard Drawing Tool');
        console.log('üì° API URL:', API_BASE_URL);
        console.log('üîß Features: Pagination, Image Display, Search, Filtering, Billiard Drawing Tool');
    </script>
</body>
</html>